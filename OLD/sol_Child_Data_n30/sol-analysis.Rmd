---
title: "SOL-Data Analysis"
author: "Kyle MacDonald"
date: "August 19, 2014"
output: html_document
---

#### Script to analyze SOL PEEK data 

Load libraries.

```{r load libraries, message=F, warning=F}
source("/Users/kmacdonald/Documents/programming/rscripts/RScripts_v_3.6/libraries_v_3.6.R")
source("/Users/kmacdonald/Documents/Projects/SOC_XSIT/XSIT-MIN/analysis/Ranalysis/useful.R")
#source("http://www.stanford.edu/~ricardoh/fortify.R")
library(ggplot2)
library(dplyr)
```

Read in iChart.

```{read iChart}

```


#### Explore data 

```{r explore data, message=F, warning=F}
## check iChart
check(iChart)

## Checks the distribution of C, D, T, and A at F0
iChart %>% 
      group_by("0", Response) %>%
      summarise(n())
```


#### Set Respones and Filtering Criteria 

```{r set responses, message=F, warning=F}
# Set all conditions to be van  
iChart$Condition <- "vanilla"

## define onset and reject prescreen
iChart <- defineOnsetSOL(iChart[iChart$Prescreen.Notes == "",], critonset=0, 
                         includeOffCenter=FALSE)

## check iChart after setting response (should only have Ds and As)
iChart %>% 
      group_by("0", Response) %>%
      summarise(n())
```

#### Find and flag C-D-T and C-T trial types

```{r c-d-t}

```

### Compute accuracy

```{r compute accuracy, message=F, warning=F}
# check iChart for number of trials
check(iChart)

# compute gaps
iChart <- computeStatistics(iChart, startWindow=0, endWindow=4000)

# reject trials with extreme RT and gaps
iChart <- filteriChart(iChart, minRT=300, maxRT=3500, maxfirstgap=15, maxlonggap=15)

## Compute accuracy
accuracy <- poolData(meanAccuracy(iChart, startWindowAcc=300, endWindowAcc=1800), 
                     RejectFirstGap=TRUE,RejectLongestGap=TRUE, RejectRT=FALSE, 
                     color=TRUE, dependent="Accuracy", group="", facet="", dodge="", 
                     xlab="", ylab= "Proportion\n  Looking\n  to target", paired=TRUE, 
                     miny = 0.2, maxy = 0.80, size=13, legend.direction="horizontal", 
                     legend.position="bottom", breaks=c(0.25, 0.50, 0.75))
                     
```

#### Accuracy: Median Split

```{r acc median split}
## change months to a numeric to do median split
iChart$Months <- as.numeric(iChart$Months) 

## median split by age (months)
iChart$Condition <- ifelse(iChart$Months >= median(iChart$Months, na.rm=TRUE), "H", "L") 

## compute accuracy for each age group (high and low)

accuracy.by.condition <- poolData(meanAccuracy(iChart, startWindowAcc=300, endWindowAcc=1800), 
                                  RejectFirstGap=FALSE, RejectLongestGap=FALSE, 
                                  RejectRT=FALSE, color=TRUE, dependent="Accuracy", 
                                  group="", facet="Condition", dodge="", 
                                  xlab="", ylab= "Proportion\n  Looking\n  to target", 
                                  paired=TRUE, miny = 0.2, maxy = 0.80, size=13, 
                                  legend.direction="horizontal", legend.position="bottom", 
                                  breaks=c(0.25, 0.50, 0.75))
```


#### Accuracy with age and vocab 

```{r read in demo file}
sol.demo <- read.csv("/Users/kmacdonald/Documents/Projects/SOL/SOL_Data/data/sol.demo.data.csv")
ms_sol <- join(sol.demo, accuracy, by = "Sub.Num")
```

Compute and plot correlations between age/vocab and peek

```{r acc/vocab correlations and plots, fig.width=12}
# filter out subs (kids who didn't know the signs on the peek)
ms_sol_filt <- filter(.data = ms_sol, include == 1, age_months >= 15)

# correlation between age and accuracy on peek
cor.test(ms_sol_filt$vanilla, ms_sol_filt$age_months)

# plot
age_acc_plot <- ggplot(data=ms_sol_filt, aes(x=age_months, y=vanilla)) +
                        geom_point(size=4) + 
                        xlab("Age (months)") +
                        ylab("Mean Accuracy") +
                        ylim(0.44, 0.75) +
                        theme(axis.title.x=element_text(vjust=-0.5)) +
                        theme(axis.title.y=element_text(vjust=0.1)) +
                        stat_smooth(method="lm", se=FALSE) +
                        ggtitle("Positive Relationship Between Age and Accuracy") +
                        geom_text(x=35, y=0.5, label="r(24) = .48", size = 8, face="bold")


cor.test(ms_sol_filt$vanilla, ms_sol_filt$signs_produced)

# plot
cdi_acc_plot <- ggplot(data=ms_sol_filt, aes(x=signs_produced, y=vanilla)) +
                        geom_point(size=4) + 
                        xlab("Signs Produced") +
                        ylab("Mean Accuracy") +
                        ylim(0.42, 0.75) +
                        theme(axis.title.x=element_text(vjust=-0.5)) +
                        theme(axis.title.y=element_text(vjust=0.3)) +
                        stat_smooth(method="lm", se=FALSE) +
                        ggtitle("Positive Relationship Between Vocabulary and Accuracy") +
                        geom_text(x=65, y=0.5, label="r(21) = .44", size = 8, face="bold")

multiplot(age_acc_plot, cdi_acc_plot, cols = 2)
```

#### Profile plot

```{r accuracy profile plot, message=F, warning=F}
createPlots(iChart, startWindow=300, endWindow=3000, RejectLongestGap=FALSE, 
            RejectFirstGap=FALSE, RejectRT=FALSE, color=TRUE, smooth=400, 
            targetEnd=800, carrier="", targets=c(""), 
            group="",  plotStats="PP", miny = 0.4, maxy=0.85, size=15, 
            legend.direction = "horizontal", legend.position=c(0.7, 0.95), 
            breaks=c(0.25, 0.50, 0.75), x.target=0.33)
```

### RT Analysis 

Clean up iChart for RT analysis. Set responses and filtering criteria.

```{r RT, message=F, warning=F}
iChart <- readiChart("/Users/kmacdonald/Documents/Projects/SOL/SOL_Data/sol_Child_Data_n30/icoder_dump/sol-vanilla-n30.txt")

# At F0, changes all 0.5s to 0
iChart[iChart$"0" == ".5", "0"] <- "0"

## for loop: 
col_i <- match("0",names(iChart)):match("3500",names(iChart))
for(i in col_i) {
  iChart[iChart[,i] == ".5", i] <- 0
}

## Set all trials to condition 'van' for vanilla
iChart$Condition <- "van"

## Read Months variable as numeric
iChart$Months <- as.numeric(iChart$Months)

## Split data set by median age
# iChart$Condition <- ifelse(iChart$Months >= median(iChart$Months, na.rm=TRUE), "H", "L")

## Define critical onset, in this case we set it to 0 
iChart <- defineOnset(iChart[iChart$Prescreen.Notes == "",], critonset=0, includeAways=FALSE)

## Compute statistics, setting the start and end windows 
iChart <- computeStatistics(iChart, startWindow=0, endWindow=4000)

## Filter iChart, setting your filtering criteria 
iChart <- filteriChart(iChart, minRT=300, maxRT=4000, maxfirstgap=15, maxlonggap=15)
```

Compute RT 

```{r compute RT, message=F,warning=F}
## Compute RT for each subjet
RT <- poolData(iChart[iChart$Response == "D",], RejectFirstGap=FALSE, 
               RejectLongestGap=FALSE, RejectRT=TRUE, color=FALSE, dependent="RT", 
               group="", facet="", dodge="Response", xlab="", ylab="mean RT (ms)", 
               paired=TRUE, miny = 400, maxy=1300, size=13, 
               legend.direction = "horizontal", legend.position="bottom", 
               breaks=c(400, 800, 1200))

# Merge RTs to the aggregate data frame
ms_sol <- join(ms_sol, RT, by = "Sub.Num")

# write out aggregate
write.csv(ms_sol, 
            file="/Users/kmacdonald/Documents/Projects/SOL/SOL_Data/SOL_n35_demo_peek.csv", 
            na="NA", row.names=F)
```

RT correlations and plots

```{r RT correlations}
ms_sol_filt_rt <- filter(.data = ms_sol, include == 1, age_months >= 15)

#remove outlier 
ms_sol_filt_rt <- filter(.data = ms_sol, include == 1, age_months >= 15, van_D <= 2000)


# correlation between age and accuracy on peek
cor.test(ms_sol_filt_rt$van_D, ms_sol_filt_rt$age_months)
cor.test(ms_sol_filt_rt$van_D, ms_sol_filt_rt$signs_produced)

# plot
age_rt_plot <- ggplot(data=ms_sol_filt_rt, aes(x=age_months, y=van_D)) +
                        geom_point(size=4) + 
                        xlab("Age (months)") +
                        ylab("Reaction Time") +
                        theme(axis.title.x=element_text(vjust=-0.5)) +
                        theme(axis.title.y=element_text(vjust=0.1)) +
                        stat_smooth(method="lm", se=FALSE) +
                        ggtitle("Positive Relationship Between Age and RT") +
                        geom_text(x=35, y=0.5, label="r(24) = .48", size = 8, face="bold")


# plot
cdi_rt_plot <- ggplot(data=ms_sol_filt_rt, aes(x=signs_produced, y=van_D)) +
                        geom_point(size=4) + 
                        xlab("Signs Produced") +
                        ylab("Reaction Time") +
                        theme(axis.title.x=element_text(vjust=-0.5)) +
                        theme(axis.title.y=element_text(vjust=0.3)) +
                        stat_smooth(method="lm", se=FALSE) +
                        ggtitle("Positive Relationship Between Vocabulary and RT") +
                        geom_text(x=65, y=0.5, label="r(21) = .44", size = 8, face="bold")

multiplot(age_rt_plot, cdi_rt_plot, cols = 2)
```

