---
title: "SOL item analysis"
author: "Kyle MacDonald"
date: "1/3/2017"
output: html_document
---

```{r setup, include = F}
rm(list=ls()) # clear workspcace
knitr::opts_chunk$set(fig.height=4, fig.width=7, cache = T,warning=F, message=F)
source("../helper_functions/useful.R")
library(langcog); library(knitr); library(forcats)
library(magrittr); library(tidyverse)
theme_set(ggthemes::theme_few())
```

Read data:

* Sign lengths
* RT and accuracy for each sign

```{r}
d <- read_csv("../../data/processed_data/summary_tables/sol_trial_level_df.csv")
sign_lengths <- read_csv("../../data/processed_data/summary_tables/target_sign_lengths.csv")
```

First we need to create "sign" variable in summary table so we can add the sign length information.

```{r}
d %<>% 
  mutate(sign = ifelse(stimuli == "V1", paste0(clean_target_img, "_p"),
                       paste0(clean_target_img, "_r")))
```

Now we can add the sign length information to our data frame and calculate a new variable where we add 300 ms to the length of the target sign in order to account for the time it takes to program an eye movement. That is, we consider eye movements that occurred up to 300 ms after the offset of the target sign as being initiated prior to sign offset, providing evidence for incremental processing. 

```{r}
d %<>% left_join(., sign_lengths, by = "sign") 
d %<>% filter(is.na(length_ms) == F) %>% 
  mutate(length_ms_300 = length_ms + 300)
```

## Item-level Analysis

Get the difference between RT and sign length for all signs. We also get the proportion of sign needed before shifting in order to normalize for the different sign lengths.


```{r}
d %<>% mutate(shift_diff_offset = (RT - length_ms_300) / 1000,
              prop_sign_to_shift = RT / length_ms_300)
```

Now summarise over these new variables

```{r}
ms <- d %>% 
  filter(correct == 1, RT <= 2000, RT >= 300) %>%
  group_by(Sub.Num, clean_target_img, age_code) %>% 
  summarise(m_shift_diff = median(shift_diff_offset)) %>% 
  group_by(clean_target_img, age_code) %>% 
  langcog::multi_boot_standard(column = "m_shift_diff", 
                               empirical_function = "mean") %>% 
  arrange(desc(mean))

ms_all_signs <- d %>% 
  filter(correct == 1, RT <= 2000, RT >= 300) %>%
  group_by(Sub.Num, clean_target_img, age_code) %>% 
  summarise(m_shift_diff = median(shift_diff_offset)) %>% 
  group_by(age_code) %>% 
  langcog::multi_boot_standard(column = "m_shift_diff", 
                               empirical_function = "mean") %>% 
  mutate(clean_target_img = ifelse(age_code == "adult", "all signs (adults)",
                                   "all signs (kids)"))
```

Forest plot

```{r}
ms %>% 
  filter(age_code == "child") %>% 
  ggplot(aes(x = reorder(clean_target_img, -mean) , y = mean)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), 
                  data = filter(ms_all_signs, age_code == "child"),
                  shape = 18, size = 1.3) +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), color = "darkgrey") +
  ylim(-0.75, 0.4) +
  coord_flip() +
  labs(y = "Mean Difference (sec)", 
       x = "Target sign")
```

Next, we do the same kind of analysis but using the `prop_sign_needed` variable, which should help account for the signs being different lengths.

```{r}
ms.2 <- d %>% 
  filter(correct == 1, RT <= 2000, RT >= 300) %>%
  group_by(Sub.Num, clean_target_img, age_code) %>% 
  summarise(m_prop_sign_needed = median(prop_sign_to_shift)) %>% 
  group_by(clean_target_img, age_code) %>% 
  langcog::multi_boot_standard(column = "m_prop_sign_needed", 
                               empirical_function = "mean") %>% 
  arrange(desc(mean))

ms_all_signs.2 <- d %>% 
  filter(correct == 1, RT <= 2000, RT >= 300) %>%
  group_by(Sub.Num, clean_target_img, age_code) %>% 
  summarise(m_prop_sign_needed = median(prop_sign_to_shift)) %>% 
  group_by(age_code) %>% 
  langcog::multi_boot_standard(column = "m_prop_sign_needed", 
                               empirical_function = "mean") %>% 
  mutate(clean_target_img = "all signs")
```

```{r}
ms.final <- bind_rows(ms.2, ms_all_signs.2) %>% 
  mutate(all_signs = ifelse(clean_target_img == "all signs", "yes", "no")) %>% 
  arrange(mean)
```

```{r}
add_plot_order <- function(data_frame) {
  
  new_df <- data_frame %>% 
    arrange(mean) %>% 
    mutate(plot_order = 1:nrow(.))
  
  all_signs_location <- new_df %>% 
    ungroup() %>% 
    filter(all_signs == "yes") %>% 
    select(plot_order) %>% 
    .[[1]]
  
  new_df %<>%  
    mutate(plot_order = ifelse(all_signs == "yes", min(plot_order),
                               ifelse(plot_order <= all_signs_location, 
                                      plot_order + 1, plot_order))) 
  
  new_df
}
```

```{r}
ms.final %<>% 
  group_by(age_code) %>% 
  do(add_plot_order(.))
```

Forest plot 2

```{r}
ms.final$age_code <- fct_relevel(ms.final$age_code, "child")

ms.final %>% 
  ggplot(aes(x = reorder(clean_target_img, plot_order), y = mean, 
             color = all_signs, shape = all_signs, size = all_signs)) +
  scale_color_manual(values = c("black", "red")) +
  scale_shape_manual(values = c(20, 18)) +
  scale_size_manual(values = c(0.8, 1.3)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) +
  ylim(0.25, 1.5) + 
  coord_flip() +
  guides(color = F, shape = F, size = F) +
  labs(y = "Prop. Target Sign", 
       x = "Target sign") +
  facet_wrap(~age_code)
```
