---
title: "SOL MLE Analysis"
author: "Kyle MacDonald"
date: "11/30/2016"
output: html_document
---

## Setup 

```{r}
rm(list=ls()) # clear workspcace
knitr::opts_chunk$set(fig.height=4, fig.width=7, cache = T,warning=F, message=F)
library(langcog); library(knitr); library(forcats); library(lme4)
library(magrittr); library(tidyverse)

theme_set(ggthemes::theme_few())
```

## Load data

```{r}
d_2500 <- read.csv("../../data/processed_data/summary_tables/sol_ss_all_600_2500.csv")
```

## Plot distributions of summary stats

Mean accuracy for each child:

```{r}
d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, prop_looking) %>% 
  unique() %>% 
  ggplot(aes(x = prop_looking)) +
  geom_line(stat="density", size = 1.5, adjust = 2) +
  labs(x = "Mean Accuracy") +
  xlim(0, 1)
```

Mean RT for each child: 

```{r}
d_2500 %>%
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, median_ct_rt) %>% 
  unique() %>% 
  ggplot(aes(x = median_ct_rt)) +
  geom_line(stat="density", size = 1.5, adjust = 2) +
  labs(x = "Median RT (msec)") +
  xlim(500, 2000)
```

## Distribution of hearing status over age

```{r}
ms_hs <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, age_peek_months, hearing_status_participant) %>% 
  unique() %>% 
  group_by(hearing_status_participant) %>% 
  summarise(mean_val = mean(age_peek_months))

d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, age_peek_months, hearing_status_participant) %>% 
  unique() %>% 
  ggplot(aes(x = age_peek_months, color = hearing_status_participant)) +
  geom_line(stat="density", size = 1, adjust = 2) +
  geom_vline(aes(xintercept = mean_val, color = hearing_status_participant), 
             data = ms_hs, size = 1, linetype = "dashed") +
  guides(color = F) +
  labs(x = "Age (months)",
       fill = "Hearing Status") +
  xlim(0, 70)  +
  scale_color_manual(values = c("darkorange", "dodgerblue")) 
  
```

## Estimate development of Acc/RT using MLE in a linear model.

```{r}
m1 <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, prop_looking, age_peek_months, hearing_status_participant) %>%
  unique() %>% 
  lm(prop_looking ~ age_peek_months + hearing_status_participant, data = .)

m1.int <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, prop_looking, age_peek_months, hearing_status_participant) %>%
  unique() %>% 
  lm(prop_looking ~ age_peek_months * hearing_status_participant, data = .)

m1.model.comp <- anova(m1, m1.int)
# the more complicated model with an interaction term for hearing status does not improve fit

m1 %>% 
  broom::tidy() %>% 
  mutate(one_sided_p =  pt(-abs(statistic), df = 28)) %>% 
  kable(digits = 3)
```

```{r}
m2 <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, median_ct_rt, age_peek_months, hearing_status_participant) %>% 
  unique() %>% 
  lm(median_ct_rt ~ age_peek_months + hearing_status_participant, data = .)

m2.int <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, median_ct_rt, age_peek_months, hearing_status_participant) %>% 
  unique() %>% 
  lm(median_ct_rt ~ age_peek_months * hearing_status_participant, data = .)

m2.model.comp <- anova(m2, m2.int)
# adding interaction term does not help model fit and is not sig, so we can drop

m2 %>% 
  broom::tidy() %>% 
  mutate(one_sided_p =  pt(-abs(statistic), df = 28)) %>% 
  kable(digits = 3)
```

```{r}
m3 <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, prop_looking, signs_produced, hearing_status_participant) %>% 
  unique() %>% 
  lm(prop_looking ~ signs_produced + hearing_status_participant, data = .)

m3.int <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, prop_looking, signs_produced, hearing_status_participant) %>% 
  unique() %>% 
  lm(prop_looking ~ signs_produced * hearing_status_participant, data = .)

m3.model.comp <- anova(m3, m3.int)
# adding interaction term does not improve model fit and is not sig

m3 %>% 
  broom::tidy() %>% 
  mutate(one_sided_p =  pt(-abs(statistic), df = 28)) %>% 
  kable(digits = 3)
```

```{r}
m4 <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, median_ct_rt,  signs_produced, hearing_status_participant) %>% 
  unique() %>% 
  lm(median_ct_rt ~ signs_produced + hearing_status_participant, data = .)

m4.int <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, median_ct_rt,  signs_produced, hearing_status_participant) %>% 
  unique() %>% 
  lm(median_ct_rt ~ signs_produced * hearing_status_participant, data = .)

m4.model.comp <- anova(m4, m4.int)
# adding interaction term does not improve model fit and is not sig
m4 %>% 
  broom::tidy() %>% 
  mutate(one_sided_p =  pt(-abs(statistic), df = 28)) %>% 
  kable(digits = 3)
```

## Split-half reliability analysis

Load trial-level data

```{r}
trial_df <- read_csv("../../data/processed_data/summary_tables/sol_trial_level_df.csv")
```

First, we create two bins of trials for each participant by sorting based on even vs. odd trial numbers.

```{r}
trial_df %<>% mutate(split_half = ifelse(Tr.Num %% 2 == 0, "first", "second"))
```

```{r, echo=F}
trial_df %>% 
  group_by(Sub.Num, age_code, split_half) %>% 
  summarise(n_trials = n())
```

```{r}
split_df <- trial_df %>% 
  group_by(Sub.Num, split_half, age_code) %>% 
  summarise(mean_acc = mean(Accuracy, na.rm = T),
            median_rt = median(RT, na.rm = T)) %>%
  gather(key = measure, value = value, mean_acc, median_rt) %>% 
  spread(key = split_half, value = value) 
```

```{r}
labels <- c(mean_acc = "Accuracy", median_rt = "RT")

ggplot(aes(x = first, y = second, color = age_code), data = split_df) +
  geom_smooth(method = "lm", se = F) +
  geom_point() +
  facet_wrap(~measure, scales = "free", labeller = labeller(measure = labels)) +
  scale_color_manual(values = c("darkorange", "dodgerblue")) +
  labs(x = "First Half", y = "Second Half", color = "Age group") 
```

```{r}
## compute pearson r
sp_r <- split_df %>% 
  group_by(age_code, measure) %>% 
  do(data.frame(pearson_r = cor(.$first, .$second, method = "pearson")))

## spearman-brown correction
sp_r %>% 
  mutate(sph_rel = round((2 * pearson_r) / (1 + pearson_r), 3)) %>% 
  kable(digits = 3)
```

What's the power that we had to detect this correlation?

```{r}
pwr::pwr.r.test(n = 29, r = 0.5, sig.level = .05, alternative = "greater")
```

```{r}
pwr::pwr.r.test(n = 29, r = 0.3, sig.level = .05, alternative = "greater")
```


