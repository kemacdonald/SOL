---
title: "SOL MLE Analysis"
author: "Kyle MacDonald"
date: "11/30/2016"
output: html_document
---

## Setup 

```{r}
rm(list=ls()) # clear workspcace
knitr::opts_chunk$set(fig.height=4, fig.width=7, cache = T,warning=F, message=F)
library(langcog); library(knitr); library(forcats); library(lme4)
library(magrittr); library(tidyverse)

theme_set(theme_minimal())
```

## Load data

```{r}
d_2500 <- read.csv("../../data/processed_data/summary_tables/sol_ss_all_600_2500.csv")
```

## Plot distributions of summary stats

Mean accuracy for each child:

```{r}
d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, prop_looking) %>% 
  unique() %>% 
  ggplot(aes(x = prop_looking)) +
  geom_density(size = 1) + 
  labs(x = "Mean Accuracy", title = "Distribution of Mean Acc") +
  xlim(0, 1)
```

Mean RT for each child: 

```{r}
d_2500 %>%
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, median_ct_rt) %>% 
  unique() %>% 
  ggplot(aes(x = median_ct_rt)) +
  geom_density(adjust = 2, size = 1) + 
  labs(x = "Median RT (msec)", title = "Distribution of Median RT") +
  xlim(500, 2000)
```

## Distribution of hearing status over age

```{r}
ms_hs <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, age_peek_months, hearing_status_participant) %>% 
  unique() %>% 
  group_by(hearing_status_participant) %>% 
  summarise(mean_val = mean(age_peek_months))

d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, age_peek_months, hearing_status_participant) %>% 
  unique() %>% 
  ggplot(aes(x = age_peek_months, fill = hearing_status_participant)) +
  geom_density(position = "identity", alpha = 0.5, adjust = 2) +
  geom_vline(aes(xintercept = mean_val, color = hearing_status_participant), 
             data = ms_hs, size = 1, linetype = "dashed") +
  guides(color = F) +
  labs(x = "Age (months)", title = "Distribution of Deaf/Hearing over age",
       fill = "Hearing Status") +
  xlim(0, 70)  +
  scale_color_manual(values = c("darkorange", "dodgerblue")) +
  scale_fill_manual(values = c("darkorange", "dodgerblue")) 
  
```

## Estimate development of Acc/RT using MLE in a linear model.

```{r}
m1 <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, prop_looking, age_peek_months, hearing_status_participant) %>%
  unique() %>% 
  lm(prop_looking ~ age_peek_months + hearing_status_participant, data = .)

m1 %>% 
  broom::tidy() %>% 
  mutate(one_sided_p =  pt(-abs(statistic), df = 28)) %>% 
  kable(digits = 3)
```

```{r}
m2 <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, median_ct_rt, age_peek_months, hearing_status_participant) %>% 
  unique() %>% 
  lm(median_ct_rt ~ age_peek_months + hearing_status_participant, data = .)

m2 %>% 
  broom::tidy() %>% 
  mutate(one_sided_p =  pt(-abs(statistic), df = 28)) %>% 
  kable(digits = 3)
```

```{r}
m3 <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, prop_looking, signs_produced, hearing_status_participant) %>% 
  unique() %>% 
  lm(prop_looking ~ signs_produced + hearing_status_participant, data = .)

m3 %>% 
  broom::tidy() %>% 
  mutate(one_sided_p =  pt(-abs(statistic), df = 28)) %>% 
  kable(digits = 3)
```

```{r}
m4 <- d_2500 %>% 
  filter(age_group != "Adults", value_cat == "Target") %>% 
  select(Sub.Num, median_ct_rt,  signs_produced, hearing_status_participant) %>% 
  unique() %>% 
  lm(median_ct_rt ~ signs_produced + hearing_status_participant, data = .)

m4 %>% 
  broom::tidy() %>% 
  mutate(one_sided_p =  pt(-abs(statistic), df = 28)) %>% 
  kable(digits = 3)
```

## Split-half reliability analysis

Load trial-level data

```{r}
trial_df <- read_csv("../../data/processed_data/summary_tables/sol_trial_level_df.csv")
```

First, we create two bins of trials for each participant by sorting based on even vs. odd trial numbers.

```{r}
trial_df %<>% mutate(split_half = ifelse(Tr.Num %% 2 == 0, "first", "second"))
```

```{r, echo=F}
trial_df %>% 
  group_by(Sub.Num, age_code, split_half) %>% 
  summarise(n_trials = n())
```

```{r}
split_df <- trial_df %>% 
  group_by(Sub.Num, split_half, age_code) %>% 
  summarise(mean_acc = mean(Accuracy, na.rm = T),
            median_rt = median(RT, na.rm = T)) %>%
  gather(key = measure, value = value, mean_acc, median_rt) %>% 
  spread(key = split_half, value = value) 
```

```{r}
labels <- c(mean_acc = "Accuracy", median_rt = "RT")

ggplot(aes(x = first, y = second, color = age_code), data = split_df) +
  geom_smooth(method = "lm", se = F) +
  geom_point() +
  facet_wrap(~measure, scales = "free", labeller = labeller(measure = labels)) +
  scale_color_manual(values = c("darkorange", "dodgerblue")) +
  labs(x = "First Half", y = "Second Half", color = "Age group",
       title = "Split Half Reliability") +
  theme_bw()
```

```{r}
## compute pearson r
sp_r <- split_df %>% 
  group_by(age_code, measure) %>% 
  do(data.frame(pearson_r = cor(.$first, .$second, method = "pearson")))

## spearman-brown correction
sp_r %>% 
  mutate(sph_rel = round((2 * pearson_r) / (1 + pearson_r), 3)) %>% 
  kable(digits = 3)
```

What's the power that we had to detect this correlation?

```{r}
pwr::pwr.r.test(n = 29, r = 0.5, sig.level = .05, alternative = "greater")
```

```{r}
pwr::pwr.r.test(n = 29, r = 0.3, sig.level = .05, alternative = "greater")
```


