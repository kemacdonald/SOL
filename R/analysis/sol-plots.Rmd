---
title: "SOL Visualization Script"
author: "Kyle MacDonald"
output: html_document
---

This document contains code for generating the visualizations that appear in the paper, "Real-time lexical comprehension in young children learning American Sign Language (ASL)."This script

```{r chunk_options}
rm(list=ls())
knitr::opts_chunk$set(warning=FALSE, message=FALSE, sanitize = T, 
                      fig.height=8, fig.width=10, echo=F, cache = F)

source("../helper_functions/libraries_v_3.6.R")
source("../helper_functions/useful.R")
library(magrittr); library(GGally); library(tidyverse)
library(cowplot); 
theme_set(theme_classic())
```

## Read in data

```{r}
gv_all <- read_csv("../../data/processed_data/graph_values/sol_gvals_all.csv")
gv_coda <- read_csv("../../data/processed_data/graph_values/sol_gvals_coda.csv")
raw_data <- read_csv("../../data/processed_data/summary_tables/sol_ss_all_600_2500.csv")
gv_categorical <- read_csv("bayesian-data-analysis/simulations/group_means_acc_rt.csv")
```

```{r}
median_sign_offset <- 1204
```

## Tanenhaus plot: Adults

```{r tanenhaus-plot}
breaks <- seq(0,4000, by=500)
y_breaks <- seq(0.25,1.0, by = 0.25)
points <- seq(0,4000, by = 200)

tan_adults <- gv_all %>% 
  filter(age_group == "Adults") %>% 
  ggplot(aes(x = to.n(Time.ms), y = mean_prop_looking, color = value_cat), 
         data = .) + 
  ylim(-.02,1) +
  geom_rect(aes(xmin = 600, xmax = 2500, ymin = -Inf, ymax = -.02), alpha = 0.1, 
            fill = "grey70", color = NA) +
  geom_vline(xintercept = 1200, linetype = "dashed") +
  geom_line(data = filter(gv_all, to.n(Time.ms) %in% points, 
                          age_group == "Adults"), size=0.7) +
  geom_linerange(data = filter(gv_all, Time.ms %in% points, 
                               age_group == "Adults"),
                 aes(ymin=mean_prop_looking - ci_low, 
                     ymax=mean_prop_looking + ci_high), size = 0.5, alpha = 0.5) +
  geom_point(data = filter(gv_all, to.n(Time.ms) %in% points, 
                           age_group == "Adults"), size=1.5, stroke = 1) +
  xlim(0,4000) +
  scale_color_manual(values = c("grey70", "grey50", "grey1")) +
  labs(x = "Time in ms from onset of noun", y = "Proportion looking") +
  guides(color = F) +
  theme(plot.margin = unit(c(1,4,1,1), "lines"),
        text = element_text(size = 14)) +
  annotate(geom = "text", label = "median sign offset", x = 1900, y = 1.0) +
  annotation_custom(grob = textGrob(label = "Signer"),
                    ymin = 0.7,      
                    ymax = 0.75,
                    xmin = 4300,         
                    xmax = 4500) +
  annotation_custom(grob = textGrob(label = "Target"),
                    ymin = 0.28,      
                    ymax = 0.35,
                    xmin = 4300,         
                    xmax = 4500) +
  annotation_custom(grob = textGrob(label = "Distracter"),
                    ymin = 0,      
                    ymax = 0,
                    xmin = 4300,         
                    xmax = 4600)

# Code to override clipping
gt <- ggplot_gtable(ggplot_build(tan_adults))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

## Tanenhaus plot: CODA/Deaf

```{r coda-deaf-plot}
breaks <- seq(0,4000, by=500)
y_breaks <- seq(0.25,1.0, by = 0.25)
points <- seq(0,4000, by = 300)

tan_kids <- ggplot(aes(x = to.n(Time.ms), y = mean_prop_looking, 
                       linetype = hearing_status_participant, 
                       color = value_cat, shape = hearing_status_participant), 
                   data = gv_coda) + 
  geom_rect(aes(xmin = 600, xmax = 2500, ymin = -Inf, ymax = -.02), alpha = 0.1, 
            fill = "grey70", color = NA) +
  geom_vline(xintercept = 1200, linetype = "dashed") +
  geom_line(data = filter(gv_coda, Time.ms %in% points), size=0.7) +
  geom_linerange(data = filter(gv_coda, Time.ms %in% points),
                 aes(ymin=mean_prop_looking - ci_low, 
                     ymax=mean_prop_looking + ci_high), size=0.5, alpha = 0.7) +
  geom_point(data = filter(gv_coda, to.n(Time.ms) %in% points), size=1.5, 
             fill = "white", stroke = 1.5) +
  annotate(geom = "text", label = "median sign offset", x = 1900, y = 1.0) +
  scale_shape_manual(values = c(19, 21)) +
  scale_color_manual(values = c("grey70", "grey50", "grey1")) +
  xlim(0, 4000) +
  ylim(-.02,1) +
  guides(color = F, linetype = F, fill = F)  +
  labs(x = "Time in ms from onset of noun", y = "Proportion looking",
       shape = "Hearing status:") +
  theme(plot.margin = unit(c(1,4,1,1), "lines"),
        text = element_text(size = 14),
        legend.position=c(1,1),legend.justification=c(1,1),
        legend.background = element_rect(fill="transparent"))  +
  annotation_custom(grob = textGrob(label = "Signer"),
                    ymin = 0.5,      
                    ymax = 0.55,
                    xmin = 4300,         
                    xmax = 4500) +
  annotation_custom(grob = textGrob(label = "Target"),
                    ymin = 0.28,      
                    ymax = 0.35,
                    xmin = 4300,         
                    xmax = 4500) +
  annotation_custom(grob = textGrob(label = "Distracter"),
                    ymin = 0.1,      
                    ymax = 0.15,
                    xmin = 4300,         
                    xmax = 4600)

# Code to override clipping
gt_kids <- ggplot_gtable(ggplot_build(tan_kids))
gt_kids$layout$clip[gt_kids$layout$name == "panel"] <- "off"
grid.draw(gt_kids)
```

## Summary violin for categorical analyses

Get means and confidence intervals for accuracy and RT

```{r}
ms_acc <- raw_data %>% 
  select(Sub.Num, mean_prop_looking_TD, age_group_collapsed, value_cat,
         hearing_status_participant) %>% 
  filter(value_cat == "Target") %>%
  rename(age_group = age_group_collapsed,
         hearing_status = hearing_status_participant) %>% 
  group_by(age_group, hearing_status) %>% 
  langcog::multi_boot_standard(column = "mean_prop_looking_TD",
                               empirical_function = "median") %>% 
  mutate(plot_value = median,
         age_var_clean = ifelse(age_group == "Kids", "children", "adults")) 
```

```{r}
gv_categorical %<>% 
  group_by(age_group, measure) %>% 
  mutate(m = mean(posterior_sample),
         stdev = sd(posterior_sample),
         hdi_lower = quantile(posterior_sample, probs = 0.025),
         hdi_upper = quantile(posterior_sample, probs = 0.975),
         plot_value = posterior_sample,
         age_var_clean = ifelse(age_group == "kids", "children", "adults")) 

m_hdi <- gv_categorical %>% 
  ungroup() %>% 
  select(hearing_status, age_var_clean, m, hdi_lower, hdi_upper, measure) %>% 
  distinct() %>% 
  rename(plot_value = m)
```

```{r}
acc_violin <- gv_categorical %>% 
  filter(measure == "accuracy") %>% 
  ggplot(., aes(x = age_var_clean, y = plot_value, 
                fill = hearing_status)) +
  geom_violin(size = 1, adjust = 2, draw_quantiles = 0.5, color = "grey50", alpha = 0.85) +
  geom_hline(yintercept = 0.5, linetype = "dashed", alpha = 0.4) +
  scale_x_discrete(limits=c("children","adults"), expand=c(0.5, 0)) +
  ylim(0.2, 1) +
  labs(x = "Age Group", y = "Prop. Target Looking", fill = "Hearing status") +
  scale_color_manual(values = c("grey", "black")) +
  scale_fill_manual(values = c("black", "white")) +
  guides(color = F) +
  theme(text = element_text(size = 14))
```

Extract and then remove the legend

```{r}
legend <- get_legend(acc_violin)
acc_violin <- acc_violin + theme(legend.position = "none")
```


```{r}
rt_violin <- gv_categorical %>% 
  filter(measure == "rt") %>% 
  ggplot(., aes(x = age_var_clean, y = posterior_sample, 
                fill = hearing_status)) +
  geom_violin(size = 1, adjust = 2, draw_quantiles = 0.5, color = "grey50", alpha = 0.85) +
  scale_x_discrete(limits=c("children","adults"), expand=c(0.5, 0)) +
  ylim(500, 1500) +
  labs(x = "Age Group", y = "RT (ms)", color = "Hearing Status") +
  scale_color_manual(values = c("grey", "black")) +
  scale_fill_manual(values = c("black", "white")) +
  guides(color = F, fill = F) +
  theme(text = element_text(size = 14))
```

Add plot labels

```{r}
gt_kids <- ggdraw(gt_kids) + draw_plot_label("A")
gt <- ggdraw(gt) + draw_plot_label("B")
acc_violin <- ggdraw(acc_violin) + draw_plot_label("C")
rt_violin <- ggdraw(rt_violin) + draw_plot_label("D")
```

Merge plots

```{r}
fig1 <- ggdraw() +
  draw_plot(gt_kids, x = 0, y = .5, width = 0.6, height = .5) +
  draw_plot(gt, x = 0, y = 0, width = 0.6, height = .5) +
  draw_plot(acc_violin, x =0.7, y = 0.55, width = .3, height = .4) +
  draw_plot(rt_violin, x = 0.7, y = 0.05, width = .3, height = .4) 

# add legend
final_plot <- plot_grid(fig1, legend, rel_widths = c(1, .2))
```

Save the final plot

```{r}
save_plot(filename = "../../paper/sol-figs/fig2_timecourse.png", final_plot,
          ncol = 3,
          nrow = 2,
          base_aspect_ratio = 1)
```


