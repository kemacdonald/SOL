---
title: "SOL BDA Categorical Models"
author: "Kyle MacDonald"
output: html_document
bibliography: bda.bib
---

In this document, you will find the details of our Bayesian categorical models for the paper, "Real-time Language Comprehension in American Sign Language." 

## Load packages and data

```{r, echo = F}
rm(list=ls()) # clear workspcace
knitr::opts_chunk$set(fig.height=4, fig.width=7, cache = T,warning=F, message=F, results = "hide")

source("../../helper_functions/useful.R")

library(langcog); library(knitr); library(forcats);
library(polspline); library(rethinking); 
library(magrittr); library(tidyverse)
theme_set(ggthemes::theme_few())
```

Load data

```{r}
d <- read.csv("../../../data/processed_data/summary_tables/sol_ss_all_600_2500.csv",
              stringsAsFactors = F)

d_voc <- read.csv("../../../data/processed_data/summary_tables/sol_ss_all_600_2500.csv",
                  stringsAsFactors = F)
```

## Age as categorical variable

All categorical models were fit using STAN [@rstan], and are based on code adapted from @mcelreath2016statistical.  

First we need to create dummy variables for the relevant group comparisons.

```{r dummy vars}
d_model <- d %>% 
  mutate(age_group_older = ifelse(age_group == ">= 27 Months", 1, 0),
         age_group_adults = ifelse(age_group == "Adults", 1, 0),
         age_group_clean = ifelse(age_group_older == 1, "Older", 
                                  ifelse(age_group_adults == 1, "Adult", 
                                         "Younger")),
         age_group_adults_collapsed = ifelse(age_group == "Adults", 1, 0),
         hearing_group = ifelse(hearing_status_participant == "hearing", 1, 0)) %>% 
  dplyr::rename(median_rt = median_ct_rt)
```

### CODA vs. Deaf

Compare accuracy for deaf and hearing kids. All priors are vague since we are just concerned with parameter estimation. 

```{r hearing_status acc}
acc_hearing_stat_cat_targ.m <- map2stan(
  alist(
    mean_prop_looking_TD ~ dnorm(mu, sigma),
    mu <- Intercept + b_Hearing*hearing_group,
    Intercept ~ dnorm(0.6, 10), 
    b_Hearing ~ dnorm(0, 1),
    sigma ~ dunif(0, 10)
  ),
  data = select(filter(d_model, value_cat == "Target", 
                       age_group_collapsed == "Kids"),
                mean_prop_looking_TD, hearing_group))

# get samples
post_hearing_stat.acc <- extract.samples(acc_hearing_stat_cat_targ.m)
hearing <- post_hearing_stat.acc$Intercept
deaf <- post_hearing_stat.acc$b_Hearing + post_hearing_stat.acc$Intercept
post_df_hearing_stat.acc <- data.frame(hearing, deaf) %>% 
  gather(key = hearing_status, value = posterior_sample) %>% 
  mutate(age_group = "kids",
         measure = "accuracy")

# print means and HDIs
precis(post_df_hearing_stat.acc)

# test contrast
diff.deaf.hearing <- hearing - deaf
quantile(diff.deaf.hearing, probs = c(0.025, 0.5, 0.975))
```

Compare RT for deaf and hearing kids.

```{r hearing_status rt}
rt_hearing_stat.m <- map2stan(
  alist(
    median_rt ~ dnorm(mu, sigma),
    mu <- Intercept + b_Hearing*hearing_group,
    Intercept ~ dnorm(1300, 100), 
    b_Hearing ~ dnorm(0, 500),
    sigma ~ dunif(0, 500)
  ),
  data = select(filter(d_model, value_cat == "Target", age_group_collapsed == "Kids"), 
                median_rt, hearing_group)
)

# extract samples
post_hearing_stat.rt <- extract.samples(rt_hearing_stat.m)
hearing <- as.numeric(post_hearing_stat.rt$Intercept)
deaf <- as.numeric(post_hearing_stat.rt$b_Hearing + post_hearing_stat.rt$Intercept)

post_hearing_stat.rt <- data.frame(hearing, deaf) %>% 
  gather(key = hearing_status, value = posterior_sample) %>% 
  mutate(age_group = "kids",
         measure = "rt")

# test contrast
diff.deaf.hearing.rt <- hearing - deaf
quantile(diff.deaf.hearing.rt, probs = c(0.025, 0.5, 0.975))
```


### Target looking for each age group

Test older vs. younger age group.

```{r age_group acc}
acc_age_cat_targ.m <- map2stan(
  alist(
    mean_prop_looking_TD ~ dnorm(mu, sigma),
    mu <- Intercept + b_Older*age_group_older + b_Adults*age_group_adults,
    Intercept ~ dnorm(0.6, 10), 
    b_Older ~ dnorm(0, 1),
    b_Adults ~ dnorm(0, 1),
    sigma ~ dunif(0, 10)
  ),
  data = select(filter(d_model, value_cat == "Target"), mean_prop_looking_TD, 
                age_group_adults, age_group_older)
)

post_ages.acc <- extract.samples(acc_age_cat_targ.m)

mu.younger <- post_ages.acc$Intercept
mu.older <- post_ages.acc$b_Older + post_ages.acc$Intercept
mu.adults <- post_ages.acc$b_Adults + post_ages.acc$Intercept
post_df.acc <- data.frame(mu.younger, mu.older, mu.adults)
precis(post_df.acc)

# contrast older vs. younger (target looking)
diff.old.young <- mu.younger - mu.older
quantile(diff.old.young, probs = c(0.025, 0.5, 0.975))
```

### RT for each age group

```{r age_group rt}
rt_age_cat.m <- map2stan(
  alist(
    median_rt ~ dnorm(mu, sigma),
    mu <- Intercept + b_Older*age_group_older + b_Adults*age_group_adults,
    Intercept ~ dnorm(1300, 100), 
    b_Older ~ dnorm(0, 500),
    b_Adults ~ dnorm(0, 500),
    sigma ~ dunif(0, 500)
  ),
  data = select(filter(d_model, value_cat == "Target"), median_rt, age_group_older, age_group_adults)
)

post_ages.rt <- extract.samples(rt_age_cat.m)

mu.younger.rt <- as.numeric(post_ages.rt$Intercept)
mu.older.rt <- as.numeric(post_ages.rt$b_Older + post_ages.rt$Intercept)
mu.adults.rt <- as.numeric(post_ages.rt$b_Adults + post_ages.rt$Intercept)
post_df.rt <- data.frame(mu.younger.rt, mu.older.rt, mu.adults.rt) 
precis(post_df.rt)

diff.old.young.rt <- mu.older.rt - mu.younger.rt  
quantile(diff.old.young.rt, probs = c(0.025, 0.5, 0.975))
```

### Target vs. Distractor looking for each age group

```{r}
acc_age_cat_dist.m <- map2stan(
  alist(
    mean_prop_looking_TD ~ dnorm(mu, sigma),
    mu <- Intercept + b_Older*age_group_older + b_Adults*age_group_adults,
    Intercept ~ dnorm(0.6, 10), 
    b_Older ~ dnorm(0, 1),
    b_Adults ~ dnorm(0, 1),
    sigma ~ dunif(0, 10)
  ),
  data = select(filter(d_model, value_cat == "Distractor"), mean_prop_looking_TD, 
                age_group_adults, age_group_older)
)

# get samples
post_ages.dist <- extract.samples(acc_age_cat_dist.m)

# Distractor: compute averages for each group (intercept is youngest kids)
mu.younger.dist <- post_ages.dist$Intercept
mu.older.dist <- post_ages.dist$b_Older + post_ages.dist$Intercept
mu.adults.dist <- post_ages.dist$b_Adults + post_ages.dist$Intercept
post_df.dist <- data.frame(mu.younger.dist, mu.older.dist, mu.adults.dist)
precis(post_df.dist)

# Merge Target and Distractor looking posterior samples
post_df.dist$looking_type <- "Distractor"
post_df.dist %<>% rename(mu.younger = mu.younger.dist,
                         mu.older = mu.older.dist,
                         mu.adults = mu.adults.dist)
post_df.acc$looking_type <- "Target"
post_df.acc_all <- rbind(post_df.acc, post_df.dist)

# target vs. distractor looking at each time point
diff.targ.dist.young <- mu.younger - mu.younger.dist
quantile(diff.targ.dist.young, probs = c(0.025, 0.5, 0.975))

diff.targ.dist.older <- mu.older - mu.older.dist
quantile(diff.targ.dist.older, probs = c(0.025, 0.5, 0.975))

diff.targ.dist.adults <- mu.adults - mu.adults.dist
quantile(diff.targ.dist.adults, probs = c(0.025, 0.5, 0.975))
```

### Accuracy and RT for kids compared to adults

```{r age_groups_adults acc}
acc_age_cat_targ.m.collapsed <- map2stan(
  alist(
    mean_prop_looking_TD ~ dnorm(mu, sigma),
    mu <- Intercept + b_Adults*age_group_adults_collapsed,
    Intercept ~ dnorm(0.6, 10), 
    b_Adults ~ dnorm(0, 1),
    sigma ~ dunif(0, 10)
  ),
  data = select(filter(d_model, value_cat == "Target"), mean_prop_looking_TD, 
                age_group_adults_collapsed)
)

post_ages.acc_collapsed <- extract.samples(acc_age_cat_targ.m.collapsed)

kids <- post_ages.acc_collapsed$Intercept
adults <- post_ages.acc_collapsed$b_Adults + post_ages.acc_collapsed$Intercept

# get samples
post_df.acc.collapsed <- data.frame(kids, adults) %>% 
  gather(key = age_group, value = posterior_sample) %>% 
  mutate(hearing_status = "deaf", 
         measure = "accuracy")

diff.old.young.acc.collapsed <- mu.kids.collapsed - mu.adults.collapsed
quantile(diff.old.young.acc.collapsed, probs = c(0.025, 0.5, 0.975))
```

```{r age_group_adults rt}
rt_age_cat_collapsed.m <- map2stan(
  alist(
    median_rt ~ dnorm(mu, sigma),
    mu <- Intercept + b_Adults*age_group_adults_collapsed,
    Intercept ~ dnorm(1300, 100), 
    b_Adults ~ dnorm(0, 500),
    sigma ~ dunif(0, 500)
  ),
  data = select(filter(d_model, value_cat == "Target"), median_rt, age_group_adults_collapsed)
)

post_ages.rt_collapsed <- extract.samples(rt_age_cat_collapsed.m)

kids <- as.numeric(post_ages.rt_collapsed$Intercept)
adults <- as.numeric(post_ages.rt_collapsed$b_Adults + post_ages.rt_collapsed$Intercept)

post_df.rt.collapsed <- data.frame(kids, adults) %>% 
  gather(key = age_group, value = posterior_sample) %>% 
  mutate(hearing_status = "deaf", 
         measure = "rt")


diff.old.young.rt.collapsed <- mu.kids.rt.collapsed - mu.adults.rt.collapsed
quantile(diff.old.young.rt.collapsed, probs = c(0.025, 0.5, 0.975))
```

### Merge model output for ACC/RT coda-deaf comparisons to be used in the plotting script.

```{r}
model_output <- bind_rows(post_df_hearing_stat.acc, post_hearing_stat.rt,
                          post_df.acc.collapsed, post_df.rt.collapsed)

write_csv(model_output, "simulations/group_means_acc_rt.csv")
```

## References