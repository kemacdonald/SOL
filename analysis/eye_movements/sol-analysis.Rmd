---
title: "SOL-analysis"
author: "Kyle MacDonald"
date: "June 9, 2015"
output: html_document
---

# Data processing, plotting, and analysis script 

```{r chunk_options}
rm(list=ls())
knitr::opts_chunk$set(warning=FALSE, message=FALSE, sanitize = T, 
                      fig.height=8, fig.width=10, echo=F, cache = T)
```

```{r, echo=FALSE, warning=F, message=F}
source("../helpers/libraries_v_3.6.R")
source("../helpers/useful.R")
library(magrittr)
library(stringr)
library(GGally)
library(kmr)
library(dplyr)
library(tidyr)
```

## Read Data

Demographics

```{r}
sol_demo <- read.csv("../../raw_data/sol_demo_all.csv", stringsAsFactors = F)
sol_demo$Sub.Num <- as.character(sol_demo$Sub.Num)
```

Eye movement data

```{r}
iChart <- read.csv("../../processed_data/vanilla/sol-ichart-merged-post-gating.csv", 
                   check.names=F, stringsAsFactors=F)

iChart %<>% mutate(Sub.Num =  as.character(Sub.Num))
```

Stimuli information

```{r}
sol_target_signs_df <- read.csv("target_sign_lengths.csv")
```

## Filter dataset

Filter out participants that should not go into analyses based on exclusionary criteria: a) age, b) didnâ€™t know signs in the task, c) not enough ASL exposure.

```{r}
exclude <- sol_demo %>% 
    filter(include == "no", age_code != "adult") %>% 
    select(Sub.Num, reason_excluded) 

include <- sol_demo %>%
    filter(include == "yes") %>% 
    select(Sub.Num, include,
           reason_excluded, stimuli,
           age_code, signs_produced, 
           hearing_status_participant)

iChart <- left_join(iChart, include, by = c("Sub.Num", "stimuli")) %>% 
    filter(include == "yes")
```

### Remove unknown signs

Create a clean target image variable.

```{r}
targets <- c("juice", "cookie", "cup", "ball", "shoe", "kitty",
             "doll", "teddy", "book", "birdy", "car", "sock")

make_clean_target <- function (target_image, targets) {
    target_img_clean <- targets[str_detect(target_image, targets)]
    return(target_img_clean)
}

iChart$clean_target_img <- unlist(sapply(iChart$Target.Image, 
                                  function (x) make_clean_target(x, targets)))
```

Add unknown signs variable. Taken from sol_demo data frame.

```{r}
ss_unknown_signs <- sol_demo %>% 
    filter(include == "yes") %>% 
    select(Sub.Num, parent_report_unknown_signs)
    
iChart <- left_join(iChart, ss_unknown_signs, by = "Sub.Num")
```

Now we can filter the iChart, removing the "unknown" signs.

```{r}
ss_trials_df <- iChart %>% 
    group_by(Sub.Num, parent_report_unknown_signs) %>% 
    dplyr::summarise(Trials = n()) 

# flag unknown trials
ss_unknown <- iChart %>% 
    rowwise() %>% 
    mutate(unknown_trial = ifelse(clean_target_img %in% parent_report_unknown_signs,
                                  "unknown_sign", "known_sign")) %>%
    select(Sub.Num, Tr.Num, unknown_trial)

# join this info with the original iChart
iChart$unknown_trial <- ss_unknown$unknown_trial
    
# now filter
iChart <- filter(iChart, unknown_trial == "known_sign")

# check to make sure our filtering worked correctly
post_filter_n <- iChart %>% 
    group_by(Sub.Num) %>% 
    dplyr::summarise(Trials = n()) %>% 
    select(Trials)

ss_trials_df$post_filter <- post_filter_n$Trials

ss_trials_df <- ss_trials_df %>% 
    mutate(trials_removed = as.integer(Trials) - as.integer(post_filter))
```

Get total number of trials removed because of known signs

```{r}
sum(ss_trials_df$trials_removed)
```

### Remove prescreened out trials

```{r}
ss_prescreened <- iChart %>% 
    group_by(Sub.Num) %>% 
    filter(Prescreen.Notes != "") %>% 
    dplyr::summarise(num_prescreened = n())

ss_trials_df <- left_join(ss_trials_df, ss_prescreened, by = "Sub.Num")

ss_trials_df <- ss_trials_df %>% 
    mutate(good_trials = Trials - sum(trials_removed, num_prescreened, na.rm=T))

iChart <- filter(iChart, Prescreen.Notes == "")
```

### Remove participants for having too few trials

We define too few trials as less than or equal to 25% of the total number of
trials in the task.

```{r}
total_trials <- 32
trials_cut_point <- total_trials * .25

trials_filter <- ss_trials_df %>% 
    mutate(exclude_few_trials = ifelse(good_trials <= trials_cut_point, 
                                       "exclude", "include")) %>% 
    select(Sub.Num, good_trials, exclude_few_trials)

# get the number of participants removed by filter
trials_filter %>% group_by(exclude_few_trials) %>% dplyr::summarise(n())

# merge filtering information with iChart
iChart <- left_join(iChart, trials_filter, by = "Sub.Num")

# now filter
iChart <- filter(iChart, exclude_few_trials == "include")
```

Create final exclusions table

```{r}
exclude_df <- trials_filter %>% 
    filter(exclude_few_trials == "exclude") %>% 
    select(Sub.Num) %>% 
    mutate(reason_excluded = "too few trials") %>% 
    bind_rows(exclude)
```

### Get median split by age

```{r}
kids_age_descriptives <- iChart %>%
    filter(age_code == "child") %>%
    select(Sub.Num, Months) %>% 
    distinct() %>% 
    dplyr::summarise(median(Months), 
              max(Months),
              min(Months), 
              sd(Months),
              n()) %>% 
    print()

# add median split variable to iChart
iChart$age_group <- ifelse(iChart$Months < kids_age_descriptives$`median(Months)`, 
                           "< 27 Months", 
                           ifelse(iChart$Months >= kids_age_descriptives$`median(Months)` & 
                                      iChart$Months <= kids_age_descriptives$`max(Months)`, 
                                  ">= 27 Months",
                                  "Adults"))

iChart %<>% mutate(age_group_collapsed = ifelse(age_group == "Adults", "Adults", "Kids"))
```

```{r}
gender_df <- iChart %>%
    filter(age_code == "child") %>%
    distinct(Sub.Num) %>% 
    group_by(Sex, age_group) %>% 
    dplyr::summarise(count = unique(n())) %>% 
    print()

iChart %>% group_by(age_group) %>% 
    dplyr::summarise(n_distinct(Sub.Num),
              mean(Months), 
              min(Months), 
              max(Months))
```

### Process iChart

First, we need to process the data, keeping only those trials on which the child was looking at the signer at F0.

* C: Center
* D: Distractor
* T: Target
* A: Away

includeOffCenter == FALSE -> only include trials child was looking at center at F0

includeOffCenter == TRUE -> include trials child was looking at center, target, or distractor at F0

```{r}
iChart %>% group_by("0", Response) %>% dplyr::summarise(Trials = n())

# change all trials to "Vanilla" 
iChart$Condition <- "Vanilla"

## define critical onset, change Cs to Ds and everything else to As
iChart <- defineOnsetSOL(iChart, critonset=0, end_critonset=300, 
                         includeOffCenter = FALSE, includeWindow = FALSE)

iChart %>% group_by("0", Response) %>% dplyr::summarise(Trials = n())
```

### Flag C-T and C-D Trials

Datawiz does not tell us which shifts land on a target vs. a disctractor. So we need to use a function that flags each trial as one of the following:

* C_T: center to target
* C_D: center to distractor
* C-C: center to center (child leaves the signer, goes away, and comes back to signer)
* no_shift
* off_signer

```{r}
# apply fun to each row in our dataset to flag trial type
trial_types <- apply(iChart, 1, trial_type_fun, start = "0", end = "4000") 

# merge trial type information with iChart
iChart <- cbind(iChart, trial_types)
```

```{r}
iChart %>% group_by(trial_types) %>% dplyr::summarise(Trials = n())
```

Next, we compute statistics over long window 0-4000 ms. This will allow us to see a 
distribution of RTs, which we will use to determine our analysis window.

First, for adults.

```{r get RT analysis window adults, warning=F, message=F, fig.height = 5}
iChart_adults <- filter(iChart, age_group == "Adults")
iChart_adults <- computeStatistics(iChart_adults, startWindow=0, endWindow=4000)

# get analyisis window where 90% of RTs occur for kids, include all shifts
rts_adults <- filter(iChart_adults, trial_types %in% c("C_T"))

analysis.window_adults <- quantile(rts_adults$RT, probs=c(0.05, 0.95), na.rm=T)

ggplot(aes(RT), data = rts_adults) +
    geom_histogram() +
    geom_vline(xintercept = analysis.window_adults[1], col="red", lwd=1.5) +
    geom_vline(xintercept = analysis.window_adults[2], col="red", lwd=1.5) +
    annotate("text", x = 2500, y = 30, 
              label = "Analysis Window \n (90% RTs)")
```

Now do the same for kids.

```{r get rt analysis window kids, warning=F, message=F, fig.height = 5}
iChart_kids <- filter(iChart, age_group != "Adults")
iChart_kids <- computeStatistics(iChart_kids, startWindow=0, endWindow=4000)

# get analyisis window where 90% of RTs occur for kids, include all shifts
rts <- filter(iChart_kids, trial_types %in% c("C_T"), age_group != "Adults")

analysis.window <- quantile(rts$RT, probs=c(0.05, 0.95), na.rm=T)

ggplot(aes(x=RT), data=rts)  +
    geom_histogram() +
    geom_vline(xintercept=analysis.window[1], col="red", lwd=1.5) +
    geom_vline(xintercept=analysis.window[2], col="red", lwd=1.5) +
    annotate("text", x = 2500, y = 30, 
              label = "Analysis Window \n (90% RTs)")
```

Compute statistics over analysis window: 0-3000ms. We use 3000 ms because
it is 500 ms longer than the end of our analysis window (2500ms). This allows
us to include trials in which the participant to initiates and completes a 
shift at the very end of the analysis window.

```{r, message=F, warning=F}
iChart <- computeStatistics(iChart, startWindow=0, endWindow=3000)
iChart_kids <- computeStatistics(iChart_kids, startWindow=0, endWindow=3000)
iChart_adults <- computeStatistics(iChart_adults, startWindow=0, endWindow=analysis.window_adults[2]+500)
```

Reject trials with really long RTs and with long gaps. Gaps are defined as 
a sequence of frames when the child is not looking at either picture or 
at the signer.

```{r RT filters}
# filter for both kids and adults
iChart <- filteriChart(iChart, minRT = analysis.window[1], 
                       maxRT = analysis.window[2], 
                       maxfirstgap=15, maxlonggap=15)  

# filter for kids
iChart_kids <- filteriChart(iChart_kids, minRT = analysis.window[1], 
                       maxRT = analysis.window[2], 
                       maxfirstgap=15, maxlonggap=15) 

# filter for adults
iChart_adults <- filteriChart(iChart_adults, minRT = analysis.window_adults[1], 
                              maxRT = analysis.window_adults[2], 
                              maxfirstgap=15, maxlonggap=15) 
```

### Mean Accuracy and RT for each participant 

```{r, warning=F, message=F}
acc_ss <- poolData(meanAccuracy(iChart_kids, startWindowAcc=analysis.window[1], 
                                endWindowAcc=analysis.window[2]), 
                   RejectFirstGap=TRUE,RejectLongestGap=TRUE, 
                   RejectRT=FALSE, color=TRUE, dependent="Accuracy", 
                   group="", facet="", dodge="", 
                   xlab="", ylab= "Proportion\n  Looking\n  to target", 
                   paired=TRUE, miny = 0.2, maxy = 0.80, 
                   size=13, legend.direction="horizontal", 
                   legend.position="bottom", 
                   breaks=c(0.25, 0.50, 0.75))

rt_ss <- poolData(iChart_kids, 
                  RejectFirstGap=TRUE, RejectLongestGap=TRUE,
                  RejectRT=TRUE, color=FALSE, dependent="RT", group="trial_types", 
                  facet="", dodge="Response",
                  xlab="", ylab="mean RT (ms)", 
                  paired=TRUE, 
                  miny = 400, maxy=1300, 
                  size=13, 
                  legend.direction = "horizontal", 
                  legend.position="bottom", 
                  breaks=c(400, 800, 1200))

acc_ss_adults <- poolData(meanAccuracy(iChart_adults, startWindowAcc=300, 
                                       endWindowAcc=analysis.window_adults[2]), 
                   RejectFirstGap=TRUE,RejectLongestGap=TRUE, 
                   RejectRT=FALSE, color=TRUE, dependent="Accuracy", 
                   group="", facet="", dodge="", 
                   xlab="", ylab= "Proportion\n  Looking\n  to target", 
                   paired=TRUE, miny = 0.2, maxy = 0.80, 
                   size=13, legend.direction="horizontal", 
                   legend.position="bottom", 
                   breaks=c(0.25, 0.50, 0.75))

rt_ss_adults <- poolData(iChart_adults, 
                         RejectFirstGap=TRUE, RejectLongestGap=TRUE,
                         RejectRT=TRUE, color=FALSE, dependent="RT", group="trial_types", 
                         facet="", dodge="Response",
                         xlab="", ylab="mean RT (ms)", 
                         paired=TRUE, 
                         miny = 400, maxy=1300, 
                         size=13, 
                         legend.direction = "horizontal", 
                         legend.position="bottom", 
                         breaks=c(400, 800, 1200))
```

### Mean Acc and RT for each participant by condition 

```{r, warning=F, message=F}
acc_hearing_status <- poolData(meanAccuracy(iChart_kids, startWindowAcc=analysis.window[1],
                                            endWindowAcc=analysis.window[2]), 
                RejectFirstGap=TRUE,RejectLongestGap=TRUE, 
                RejectRT=FALSE, color=TRUE, dependent="Accuracy", 
                group="hearing_status_participant", facet="", dodge="", 
                xlab="", ylab= "Proportion\n  Looking\n  to target", 
                paired=TRUE, miny = 0.2, maxy = 0.80, 
                size=13, legend.direction="horizontal", 
                legend.position="bottom", 
                breaks=c(0.25, 0.50, 0.75))

rt_hearing_status <- poolData(iChart_kids, 
               RejectFirstGap=TRUE, RejectLongestGap=TRUE,
               RejectRT=TRUE, color=FALSE, dependent="RT", group="hearing_status_participant", 
               facet="", dodge="Response",
               xlab="", ylab="mean RT (ms)", 
               paired=TRUE, 
               miny = 400, maxy=1300, 
               size=13, 
               legend.direction = "horizontal", 
               legend.position="bottom", 
               breaks=c(400, 800, 1200))

acc <- poolData(meanAccuracy(iChart_kids, startWindowAcc = analysis.window[1], 
                             endWindowAcc = analysis.window[2]), 
                RejectFirstGap=TRUE,RejectLongestGap=TRUE, 
                RejectRT=FALSE, color=TRUE, dependent="Accuracy", 
                group="age_group", facet="", dodge="", 
                xlab="", ylab= "Proportion\n  Looking\n  to target", 
                paired=TRUE, miny = 0.2, maxy = 0.80, 
                size=13, legend.direction="horizontal", 
                legend.position="bottom", 
                breaks=c(0.25, 0.50, 0.75))

rt <- poolData(iChart_kids, 
               RejectFirstGap=TRUE, RejectLongestGap=TRUE,
               RejectRT=TRUE, color=FALSE, dependent="RT", group="age_group", 
               facet="", dodge="Response",
               xlab="", ylab="mean RT (ms)", 
               paired=TRUE, 
               miny = 400, maxy=1300, 
               size=13, 
               legend.direction = "horizontal", 
               legend.position="bottom", 
               breaks=c(400, 800, 1200))


acc_adults <- poolData(meanAccuracy(iChart_adults, startWindowAcc=300,
                                    endWindowAcc=analysis.window_adults[2]), 
                RejectFirstGap=TRUE,RejectLongestGap=TRUE, 
                RejectRT=FALSE, color=TRUE, dependent="Accuracy", 
                group="age_group", facet="", dodge="", 
                xlab="", ylab= "Proportion\n  Looking\n  to target", 
                paired=TRUE, miny = 0.2, maxy = 0.80, 
                size=13, legend.direction="horizontal", 
                legend.position="bottom", 
                breaks=c(0.25, 0.50, 0.75))


rt_adults <- poolData(iChart_adults, 
                      RejectFirstGap=TRUE, RejectLongestGap=TRUE,
                      RejectRT=TRUE, color=FALSE, dependent="RT", group="age_group", 
                      facet="", dodge="Response",
                      xlab="", ylab="mean RT (ms)", 
                      paired=TRUE, 
                      miny = 400, maxy=1300, 
                      size=13, 
                      legend.direction = "horizontal", 
                      legend.position="bottom", 
                      breaks=c(400, 800, 1200))
```

### Mean Acc and RT for each participant by condition using Tanenhaus computation

Here we analyze window accuracy based on proportion looking to either target, distractor, or signer. Since there are three fixations points, chance looking behavior is 0.33.

First, we munge the raw iChart data.

Grab just the eye movement data and group information

```{r}
ss_iChart <- iChart %>% 
    filter(GoodFirstGap == T, GoodLongestGap == T) %>% 
    select(Sub.Num, Tr.Num, age_group, Response, `0`:`4000`) 
```

Convert to long format

```{r}
ss_iChart_long <- ss_iChart %>% 
    gather(key = Time.ms, value = value, `0`:`4000`) %>% 
    filter(value %in% c("0", "1", "0.5", ".", "-")) %>%
    mutate(value = ifelse(value == "-", ".", value),
           value_cat = factor(value, labels = c("Away", "Distractor", "Signer", "Target")),
           Time.ms_numeric = to.n(Time.ms)) 
```    

### Summarize looking behavior for each participant: Signer included

* First, we get proportion looking to Target, Distractor, Away, and Signer at each time slice.

```{r}
ms_iChart_count <- ss_iChart_long %>% 
    filter(value %in% c("0", "1", ".", "0.5")) %>%  ## specify acc computation
    group_by(Sub.Num, Time.ms, age_group, value_cat) %>% 
    dplyr::summarise(count = ifelse(n() == 0, 0, n())) %>% 
    dplyr::summarise(sum_count = sum(count))
    
ms_iChart <- as.data.frame(xtabs(~ Sub.Num + value_cat + Time.ms, 
                                 data = filter(ss_iChart_long, 
                                               value %in% c("0", "1", ".", "0.5")))) %>% 
    left_join(x = ms_iChart_count, by = c("Sub.Num", "Time.ms")) %>% 
    mutate(proportion_looking = Freq / sum_count,
           age_group_factor = as.factor(age_group))
```

Now we can compute mean proportion looking to signer, target, and distractor for each participant and for each age group.

```{r}
ss_tanenhaus_comp <- ms_iChart %>% 
    filter(to.n(Time.ms) >= analysis.window[1], to.n(Time.ms) <= analysis.window[2]) %>% 
    group_by(Sub.Num, value_cat, age_group) %>% 
    dplyr::summarise(mean_prop_looking_signer = mean(proportion_looking, na.rm = T),
              ci_low_signer = ci.low(proportion_looking),
              ci_high_signer = ci.high(proportion_looking))
```

Finally, we get the mean proportion looking to each location for each age group.

```{r}
ms_tanenhaus_comp <- ss_tanenhaus_comp %>% 
    group_by(age_group, value_cat) %>% 
    dplyr::summarise(mean_group_prop_looking_signer = mean(mean_prop_looking_signer),
              ci_low_signer = ci.low(mean_prop_looking_signer),
              ci_high_signer = ci.high(mean_prop_looking_signer))
```

### Summarize looking behavior for each participant: Signer not included

* First, we get proportion looking to Target, Distractor, Away, and Signer at each time slice.

```{r}
ms_iChart_count <- ss_iChart_long %>% 
    filter(value %in% c("0", "1", ".")) %>%  ## this is where you specify what goes into acc computation
    group_by(Sub.Num, Time.ms, age_group, value_cat) %>% 
    dplyr::summarise(count = ifelse(n() == 0, 0, n())) %>% 
    dplyr::summarise(sum_count = sum(count))
    
ms_iChart <- as.data.frame(xtabs(~ Sub.Num + value_cat + Time.ms, 
                                 data = filter(ss_iChart_long, 
                                               value %in% c("0", "1", ".")))) %>% ## specify acc computation
    left_join(x = ms_iChart_count, by = c("Sub.Num", "Time.ms")) %>% 
    mutate(proportion_looking = Freq / sum_count,
           age_group_factor = as.factor(age_group))
```

Now we can compute mean proportion looking to signer, target, and distractor for each participant and for each age group.

```{r}
ss_tanenhaus_comp_no_signer <- ms_iChart %>% 
    filter(to.n(Time.ms) >= analysis.window[1], to.n(Time.ms) <= analysis.window[2]) %>% 
    filter(value_cat != "Signer") %>%  ## to add/remove signer looking from computation
    group_by(Sub.Num, value_cat, age_group) %>% 
    dplyr::summarise(mean_prop_looking_no_signer = mean(proportion_looking, na.rm = T),
              ci_low = ci.low(proportion_looking),
              ci_high = ci.high(proportion_looking))
```

Finally, we get the mean proportion looking to each location for each age group.

```{r}
ms_tanenhaus_comp_no_signer <- ss_tanenhaus_comp_no_signer %>% 
    group_by(age_group, value_cat) %>% 
    dplyr::summarise(mean_group_prop_looking = mean(mean_prop_looking_no_signer),
              ci_low = ci.low(mean_prop_looking_no_signer),
              ci_high = ci.high(mean_prop_looking_no_signer))
```

Merge the two accuracy computations together in one data frame so we can compare.

```{r}
ss_tanenhaus_comp_all <- left_join(ss_tanenhaus_comp, ss_tanenhaus_comp_no_signer,
                                   by = c("Sub.Num", "value_cat", "age_group"))

ms_tanenhaus_comp_all <- left_join(ms_tanenhaus_comp, ms_tanenhaus_comp_no_signer, 
                                   by = c("age_group", "value_cat"))
```

Plot individual conistency in accuracy computations

```{r}
ss_tan_gather <- gather(ss_tanenhaus_comp_all, key = signer_included, value = mean_looking, 
                        mean_prop_looking_signer, mean_prop_looking_no_signer) %>% 
    mutate(signer_included = ifelse(signer_included == "mean_prop_looking_signer", 
                                    "signer_included", "signer_not_included"))
```

```{r}
qplot(x = signer_included, y = mean_looking, data = filter(ss_tan_gather, value_cat == "Target"), 
      color = age_group, group = Sub.Num) +
    geom_line() +
    ylim(0, 1) +
    theme_bw() +
    ggtitle("Individual consistency across Accuracy Computations")
```

## Statistics 

Get mean accuracy and rt for each participant.

Some munging to get data frame for analysis. Variables needed for each subject: 

* Mean acc 
* Mean rt 
* Signs produced 
* Age 
* Age condition

```{r bind summary statistics}
ss_acc <- bind_rows(acc_ss, acc_ss_adults)
ss_rt <- bind_rows(rt_ss, rt_ss_adults)

# merge acc/rt van1
ss <- left_join(ss_acc, ss_rt, by="Sub.Num")

# merge with demo info
ss <- left_join(ss, filter(sol_demo, include=="yes"), by="Sub.Num")

# clean up variable names in data frame
names(ss)[names(ss)=="Vanilla"] <- "mean_accuracy"
names(ss)[names(ss)=="Vanilla_C_D_D"] <- "mean_incorrect_rt"
names(ss)[names(ss)=="Vanilla_C_T_D"] <- "mean_correct_rt"
```

Add in Tanenhaus proportion looking computation for each participant.

```{r}
ss <- ss_tanenhaus_comp_all %>% 
    select(Sub.Num, value_cat, age_group, mean_prop_looking_signer, value_cat) %>% 
    rename(prop_looking = mean_prop_looking_signer) %>% 
    left_join(ss, by = c("Sub.Num"))
```

## First shift accuracy analysis

First we need to categorize each trial type based on the analysis window.

```{r}
trial_types_analysis_kids <- apply(iChart_kids, 1, trial_type_fun, start = analysis.window[1], end = analysis.window[2])

# merge trial type information with iChart
iChart_kids <- cbind(iChart_kids, trial_types_analysis_kids)
```

Then we add this information to the summary data frame.

```{r}
# kids 
ss_first_shifts <- iChart_kids %>%
    filter(trial_types_analysis_kids %in% c("C_T", "C_D", "no_shift")) %>% 
    group_by(Sub.Num, trial_types, age_group, Months) %>% 
    dplyr::summarise(count = n()) %>% 
    spread(trial_types, count) %>% 
    mutate(C_D = ifelse(is.na(C_D), 0, C_D),
           no_shift = ifelse(is.na(no_shift), 0, C_D),
           total_trials_shifting = C_D + C_T,
           total_trials = C_D + C_T + no_shift,
           C_D_prop = round(C_D / total_trials_shifting, 2),
           C_T_prop = round(C_T / total_trials_shifting, 2),
           C_D_prop_all = round(C_D / total_trials, 2),
           C_T_prop_all = round(C_T / total_trials, 2))

# add adults
ss_first_shifts <- iChart_adults %>%
    filter(trial_types %in% c("C_T", "C_D", "no_shift")) %>% 
    group_by(Sub.Num, trial_types, age_group, Months) %>% 
    dplyr::summarise(count = n()) %>% 
    spread(trial_types, count) %>% 
    mutate(C_D = ifelse(is.na(C_D), 0, C_D),
           no_shift = ifelse(is.na(no_shift), 0, C_D),
           total_trials_shifting = C_D + C_T,
           total_trials = C_D + C_T + no_shift,
           C_D_prop = round(C_D / total_trials_shifting, 2),
           C_T_prop = round(C_T / total_trials_shifting, 2),
           C_D_prop_all = round(C_D / total_trials, 2),
           C_T_prop_all = round(C_T / total_trials, 2)) %>% 
    bind_rows(ss_first_shifts)

# add shifts to full data frame
ss <- ss_first_shifts %>% 
    dplyr::rename(Sub.Num = Sub.Num, C_D_count = C_D, C_T_count = C_T) %>% 
    left_join(ss, by = c("Sub.Num", "age_group"))

# flag chance first shifters = more than 50% posterior mass on guessing strategy
# in latent mixture model
ss <- ss %>% 
    mutate(C_D_prop = ifelse(C_T_prop == 1, 0, C_D_prop),
           exclude_chance_shifter = ifelse(Sub.Num %in% c("30018",
                                                          "30024",
                                                          "20028",
                                                          "30051", 
                                                          "30086", 
                                                          "30088"), 
                                           "exclude", "include"),
           age_group_collapsed = ifelse(age_group == "Adults", "Adults", "Kids"))
```

## Median RT 

```{r}
ss_medians <- iChart %>% 
    filter(trial_types == "C_T", 
           GoodFirstGap == T, GoodRT == T, GoodLongestGap == T) %>% 
    group_by(Sub.Num, age_group, age_group_collapsed, Months) %>% 
    dplyr::summarise(median_ct_rt = median(RT, na.rm = T))

ss <- ss_medians %>% 
    ungroup() %>% 
    select(Sub.Num, median_ct_rt) %>% 
    left_join(x = ss, by = "Sub.Num")
```

### Filter kids for RT analysis

```{r}
ss_kids <- filter(ss, age_group != "Adults")
ss_rt <- filter(ss, age_group != "Adults", exclude_chance_shifter == "include")
```

Show the number of trials shifting for each kid --> this is the number of trials going
into the First Shift Acc computaton

```{r}
ss_kids %>% 
    summarise(m_trials = mean(total_trials_shifting, na.rm = T),
              min_trials = min(total_trials_shifting, na.rm = T),
              max_trials = max(total_trials_shifting, na.rm = T))
```

Show the number of trials for each kid --> this is the number of trials going
into the Window Accuracy analysis.

```{r}
ss_kids %>% 
    summarise(m_trials = mean(total_trials, na.rm = T),
              min_trials = min(total_trials, na.rm = T),
              max_trials = max(total_trials, na.rm = T))
```


```{r, eval=F}
write.csv(ss, "../../paper/sol_ss_all.csv", row.names = F)
```

### Correlations 

```{r, fig.height=8, fig.width=10, warning=F}
ss_corr <- ss_kids %>% 
    filter(value_cat == "Target") %>% 
    select(mean_accuracy, C_T_prop, prop_looking,signs_produced, Months)

Hmisc::rcorr(as.matrix(ss_corr))

ggpairs(data = ss_corr,
        upper = list(continuous = "smooth", combo = "cor"),
        lower = list(continuous = "cor"),
        diag = list(continuous = "density")) +
    theme_bw() 
```

```{r}
qplot(mean_accuracy, prop_looking, data = filter(ss_kids, value_cat == "Target")) +
    ylim(0,1) +
    xlim(0,1) +
    geom_abline(intercept = 0, slope = 1) +
    ggrepel::geom_text_repel(aes(label = Sub.Num))
```

Just RT.

```{r, fig.height=8, fig.width=10, warning = F}
Hmisc::rcorr(as.matrix(select(ss_rt, mean_correct_rt, signs_produced, Months)))

ggpairs(data = select(ss_rt, mean_correct_rt, signs_produced, Months),
        upper = list(continuous = "smooth", combo = "cor"),
        lower = list(continuous = "cor"),
        diag = list(continuous = "density")) +
    theme_bw() 
```

### T.tests

```{r t-tests age}
t.test(mean_correct_rt ~ age_group, alternative = "two.sided", var.equal=T, 
       data = filter(ss_rt, value_cat == "Target"))

t.test(prop_looking ~ age_group, alternative = "two.sided", var.equal=T, 
       data = filter(ss_kids, value_cat == "Target"))

t.test(prop_looking ~ age_group, alternative = "two.sided", var.equal=T, 
       data = filter(ss_kids, value_cat == "Distractor"))

t.test(prop_looking ~ age_group, alternative = "two.sided", var.equal=T, 
       data = filter(ss_kids, value_cat == "Signer"))

t.test(mean_correct_rt ~ age_group_collapsed, alternative = "two.sided", var.equal = T, 
       data = ss)

t.test(prop_looking ~ age_group_collapsed, alternative = "two.sided", var.equal = T, 
       data = filter(ss, value_cat == "Distractor"))
```

```{r t-tests hearing status}
t.test(mean_accuracy ~ hearing_status_participant, alternative = "two.sided", var.equal=T, data = ss_kids)

t.test(target_looking_no_signer ~ hearing_status_participant, alternative = "two.sided", var.equal=T, data = ss_kids)

t.test(C_T_prop ~ hearing_status_participant, alternative = "two.sided", var.equal=T, data = ss_kids)

t.test(mean_correct_rt ~ hearing_status_participant, alternative = "two.sided", var.equal=T, data = ss_rt)
```

### Get confidence intervals for graph values

```{r, warning=F, message=F, eval=F}
# keeping age bins
createPlots(iChart_kids, startWindow=0, endWindow=4000, RejectLongestGap=FALSE, 
            RejectFirstGap=FALSE, RejectRT=FALSE, color=TRUE, smooth=400, 
            targetEnd=800, carrier="", targets=c(""), 
            group="age_group",  plotStats="PP", miny = 0.4, maxy=0.95, size=15, 
            legend.direction = "vertical", legend.position=c(0.85, 0.9), 
            breaks=c(0.25, 0.50, 0.75), x.target=0.33)

# keeping age bins
createPlots(iChart_adults, startWindow=0, endWindow=4000, RejectLongestGap=FALSE, 
            RejectFirstGap=FALSE, RejectRT=FALSE, color=TRUE, smooth=400,  
            targetEnd=800, carrier="", targets=c(""), 
            group="age_group",  plotStats="PP", miny = 0.4, maxy=0.95, size=15, 
            legend.direction = "vertical", legend.position=c(0.85, 0.9), 
            breaks=c(0.25, 0.50, 0.75), x.target=0.33)

# keeping target signs and separating by stimuli
iChart_v1 <- filter(iChart_kids, stimuli == "V1")
iChart_v2 <- filter(iChart_kids, stimuli == "V2")

createPlots(iChart_v1, startWindow=0, endWindow=4000, RejectLongestGap=FALSE, 
            RejectFirstGap=FALSE, RejectRT=FALSE, color=TRUE, smooth=400, 
            targetEnd=800, carrier="V1", targets=c(""), 
            group="clean_target_img",  plotStats="PP", miny = 0.4, maxy=0.95, size=15, 
            legend.direction = "vertical", legend.position=c(0.85, 0.9), 
            breaks=c(0.25, 0.50, 0.75), x.target=0.33)

createPlots(iChart_v2, startWindow=0, endWindow=4000, RejectLongestGap=FALSE, 
            RejectFirstGap=FALSE, RejectRT=FALSE, color=TRUE, smooth=400, 
            targetEnd=800, carrier="V2", targets=c(""), 
            group="clean_target_img",  plotStats="PP", miny = 0.4, maxy=0.95, size=15, 
            legend.direction = "vertical", legend.position=c(0.85, 0.9), 
            breaks=c(0.25, 0.50, 0.75), x.target=0.33)
```

## PP for each participant

```{r}
ss.et.kids <- read.table("sol-ichart-v1-post-gating_PP_graphValues_by_subs_0_4000_minRT_33_maxRT_2967_lg_72_fg_34_n_29.txt", header = T)

ss.et.adults <- read.table("sol-ichart-v1-post-gating_PP_graphValues_by_subs_0_4000_minRT_33_maxRT_2167_lg_26_fg_18_n_16.txt", header = T)

ss.et.kids$Sub.Num <- as.character(ss.et.kids$Sub.Num)
ss.et.adults$Sub.Num <- as.character(ss.et.adults$Sub.Num)

# merge
ss.et <- rbind(ss.et.kids, ss.et.adults)
```

Some munging to format data for plotting

```{r, warning=F, message=F}
detach("package:reshape", unload=TRUE)

#strip X from header
names(ss.et) <- gsub("X", "", names(ss.et))

ss.et <- left_join(ss.et, ss_kids, by="Sub.Num")

#melt to long form for plotting
ss.et.long <- reshape2::melt(ss.et, 
                   id.vars=c("Sub.Num", "Condition",
                             "Months", "signs_produced", 
                             "groupping", "hearing_status_participant"),
                   variable.name = "Time.ms",
                   value.name = "accuracy")

#convert sub.num to a factor
ss.et.long <- ss.et.long %>% 
    mutate(Sub.Num = as.factor(Sub.Num), 
           Time.ms = as.numeric(as.character(Time.ms)),
           Months = as.factor(Months),
           accuracy = as.numeric(accuracy),
           hearing_status = as.factor(hearing_status_participant)) %>% 
    rename(age_group = groupping)
```

summarise graph values for all participants.

```{r, warning=F, message=F}
ms_graph_values <- ss.et.long %>% 
    group_by(age_group, Time.ms) %>% 
    dplyr::summarise(mean_accuracy = mean(accuracy),
              ci.high = ci.high(accuracy),
              ci.low = ci.low(accuracy))

ms_graph_values_coda <- ss.et.long %>% 
    filter(age_group != "Adults") %>% 
    group_by(hearing_status, Time.ms) %>% 
    dplyr::summarise(mean_accuracy = mean(accuracy),
              ci.high = ci.high(accuracy),
              ci.low = ci.low(accuracy))
```

## PP for children (younger, older) and adults.

```{r, warning=F, echo=F}
breaks <- seq(0,3000, by=500)
y_breaks <- seq(0.25,1.0, by = 0.25)
points <- seq(0,3000, by = 200)

ggplot(aes(x = Time.ms, y = mean_accuracy, color=age_group), data = ms_graph_values) +
    xlab(label = c("Time in ms from onset of noun")) +
    ylab(label = c("ACCURACY\nProportion\nlooking\nto target")) + 
    geom_point(data = filter(ms_graph_values, Time.ms %in% points), size=3) +
    geom_line(size=0.7) +
    geom_linerange(data = filter(ms_graph_values, Time.ms %in% points),
                   aes(ymin=mean_accuracy - ci.low, 
                       ymax=mean_accuracy + ci.high), 
                   size=0.3, 
                   alpha = 1) +
    scale_color_brewer(type = "qual", palette = "Set1") +
    scale_x_discrete(breaks = breaks) +
    scale_y_continuous(limits=c(0.25, 1.0), breaks = y_breaks) +
    geom_hline(yintercept = 0.5, linetype="dashed") +
    guides(color=F) +
    xlim(0,3000) +
    theme_bw() +
    theme(axis.title.x = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))
```

## Summary bar plots for all participants

```{r}
ms_all <- ss %>% 
    group_by(age_group) %>% 
    dplyr::summarise(m_age = mean(age_peek_months),
              sd_age = sd(age_peek_months),
              m_fs = mean(C_T_prop),
              ci.h_ct = ci.high(C_T_prop),
              ci.l_ct = ci.low(C_T_prop),
              m_acc = mean(target_looking_signer),
              ci.h_acc = ci.high(target_looking_signer),
              ci.l_acc = ci.low(target_looking_signer))

ms_all <- ss %>% 
    filter(exclude_chance_shifter == "include") %>%
    group_by(age_group) %>% 
    dplyr::summarise(m_rt = mean(mean_correct_rt),
              ci.h_rt = ci.high(mean_correct_rt),
              ci.l_rt = ci.low(mean_correct_rt)) %>% 
    left_join(x = ms_all, by = "age_group")
```

Now we make the summary bar plots.

```{r summary bar plots all participants}
all_fs <- qplot(age_group, m_fs, data = ms_all, 
      fill = age_group, geom = "bar", stat = "identity") +
    geom_linerange(aes(ymax = m_fs + ci.h_ct, ymin = m_fs - ci.l_ct)) +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    guides(fill=F) +
    ylim(0, 1.0) +
    xlab("Age Group") +
    ylab("Prop. Correct Shifts") + 
    ggtitle("First Shift Accuracy") +
    geom_hline(yintercept = 0.5, linetype = "dashed") +
    scale_x_discrete(labels=c("Younger", "Older", "Adults")) +
    theme(plot.title = element_text(face = "bold", size = 20),
        axis.title.x = element_text(colour="grey40",size=18,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=18,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))

all_acc <- qplot(age_group, m_acc, data = ms_all, 
      fill = age_group, geom = "bar", stat = "identity") +
    geom_linerange(aes(ymax = m_acc + ci.h_acc, ymin = m_acc - ci.l_acc)) +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    guides(fill=F) +
    ylim(0, 0.7) +
    xlab("Age Group") +
    ylab("Prop. Looking to Target") +
    ggtitle("Accuracy") +
    geom_hline(yintercept = 0.3, linetype = "dashed") + 
    scale_x_discrete(labels=c("Younger", "Older", "Adults")) +
    theme(plot.title = element_text(face = "bold", size = 20),
        axis.title.x = element_text(colour="grey40",size=18,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=18,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))

all_rt <- qplot(age_group, m_rt, data = ms_all, 
      fill = age_group, geom = "bar", stat = "identity") +
    geom_linerange(aes(ymax = m_rt + ci.h_rt, ymin = m_rt - ci.l_rt)) +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    guides(fill=F) +
    xlab("Age Group") +
    ylab("Mean RT (ms)") +
    ggtitle("Reaction Time") +
    scale_x_discrete(labels=c("Younger", "Older", "Adults")) +
    theme(plot.title = element_text(face = "bold", size = 20),
        axis.title.x = element_text(colour="grey40",size=18,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=18,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))

gridExtra::grid.arrange(all_acc, all_rt, ncol = 2)
```

## Tanenhaus plot: all types of looking

First, we munge the raw iChart data.

Grab just the eye movement data and group information

```{r}
ss_iChart <- iChart %>% 
    filter(Response == "D", GoodFirstGap == T, GoodLongestGap == T) %>% 
    select(Sub.Num, Tr.Num, age_group, Response, `0`:`4000`) 
```

Convert to long format

```{r}
ss_iChart_long <- ss_iChart %>% 
    gather(key = Time.ms, value = value, `0`:`4000`) %>% 
    filter(value %in% c("0", "0.5", "1")) %>% 
    mutate(value_cat = factor(value, labels = c("Distractor", "Signer", "Target")),
           Time.ms_numeric = to.n(Time.ms)) 
```    

Summarize for each participant - get proportion looking at each time slice

```{r}
ms_iChart_count <- ss_iChart_long %>% 
    group_by(Sub.Num, Time.ms, age_group, value_cat) %>% 
    dplyr::summarise(count = ifelse(n() == 0, 0, n())) %>% 
    dplyr::summarise(sum_count = sum(count))
    
ms_iChart <- as.data.frame(xtabs(~ Sub.Num + value_cat + Time.ms, 
                                 data = ss_iChart_long)) %>% 
    left_join(y = ms_iChart_count, by = c("Sub.Num", "Time.ms")) %>% 
    mutate(proportion_looking = Freq / sum_count,
           age_group_factor = as.factor(age_group))
```

Get means and CIs for proportion looking at each time slice across particpants

```{r}
ms_mean_iChart <- ms_iChart %>% 
    group_by(Time.ms, age_group, value_cat) %>% 
    dplyr::summarise(mean_prop_looking = mean(proportion_looking),
              ci_low = ci.low(proportion_looking),
              ci_high = ci.high(proportion_looking))
```

Now we plot proportion looking to target, distractor, and signer for each age bin.

```{r tanenhaus-plot}
breaks <- seq(0,4000, by=500)
y_breaks <- seq(0.25,1.0, by = 0.25)
points <- seq(0,4000, by = 200)

ggplot(aes(x = to.n(Time.ms), y = mean_prop_looking, color = value_cat), 
       data = ms_mean_iChart) + 
    ylim(0,1) +
    geom_rect(aes(xmin = 600, xmax = 2500, ymin = -Inf, ymax = Inf), alpha = 0.1, fill = "grey90", color = NA) +
    geom_line(data = filter(ms_mean_iChart, to.n(Time.ms) %in% points), size=0.7) +
    geom_linerange(data = filter(ms_mean_iChart, Time.ms %in% points),
                   aes(ymin=mean_prop_looking - ci_low, 
                       ymax=mean_prop_looking + ci_high), alpha = 0.5) +
    geom_point(data = filter(ms_mean_iChart, to.n(Time.ms) %in% points), size=4) +
    xlim(0,4000) +
    geom_hline(yintercept = 0.33, linetype = "dashed") +
    facet_grid(. ~ age_group) +
    scale_color_brewer(palette = "Set1", type = "qual") +
    xlab("Time in ms from onset of noun") +
    ylab("Proportion looking") +
    guides(color = F) +
    theme_bw() +
    theme(axis.title.x = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=22,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"),
         strip.text.x = element_text(size = 18),
         panel.margin = unit(1, "lines"))
```

## Window accuracy analysis OLD

Here I want to see what happens to window accuracy when we don't penalize kids for looking at the signer.

Grab just the eye movement data and group information

```{r}
ss_iChart_window_acc <- iChart %>% 
    filter(Response == "D", GoodFirstGap == T, GoodLongestGap == T) %>% 
    select(Sub.Num, age_group, hearing_status_participant, Response, `600`:`2500`) 
```

Convert to long format

```{r}
ss_iChart_long_window_acc <- ss_iChart_window_acc %>% 
    gather(key = Time.ms, value = value, `600`:`2500`) %>% 
    filter(value %in% c("0", "0.5", "1")) %>% 
    mutate(value_cat = factor(value, labels = c("Distractor", "Signer", "Target")),
           Time.ms_numeric = to.n(Time.ms),
           value_signer_removed = ifelse(value == "0.5", NA, value)) 
```    

Get means and CIs for each participant.

```{r}
ms_mean_iChart_window_acc <- ss_iChart_long_window_acc %>% 
    group_by(Sub.Num, Time.ms, age_group) %>% 
    dplyr::summarise(mean_prop_looking_subs = mean(to.n(value), na.rm = T))

ms_mean_iChart_window_acc_no_signer <- ss_iChart_long_window_acc %>% 
    group_by(Sub.Num, Time.ms, age_group) %>% 
    dplyr::summarise(mean_prop_looking_subs = mean(to.n(value_signer_removed), na.rm = T))
```

Get means and CIs collapsing across participants 

```{r}
ms_mean_iChart_window_acc_collapsed <- ms_mean_iChart_window_acc %>% 
    group_by(Time.ms, age_group) %>% 
    dplyr::summarise(mean_prop_looking = mean(mean_prop_looking_subs, na.rm = T),
                     ci_low = ci.low(mean_prop_looking_subs),
                     ci_high = ci.high(mean_prop_looking_subs))

ms_mean_iChart_window_acc_collapsed_no_signer <- ms_mean_iChart_window_acc_no_signer %>% 
    group_by(Time.ms, age_group) %>% 
    dplyr::summarise(mean_prop_looking = mean(mean_prop_looking_subs, na.rm = T),
              ci_low = ci.low(mean_prop_looking_subs),
              ci_high = ci.high(mean_prop_looking_subs))
```

Now plot.

```{r}
breaks <- seq(0,2500, by=500)
y_breaks <- seq(0.25,1.0, by = 0.25)
points <- seq(0,2500, by = 100)

a <- qplot(data = ms_mean_iChart_window_acc_collapsed, x = Time.ms, y = mean_prop_looking,
      color=age_group, group = age_group, 
      geom = "blank", xlab=c("Time in ms from onset of noun"), 
      ylab=c("ACCURACY\nProportion\nlooking\nto target")) + 
    geom_point(data = filter(ms_mean_iChart_window_acc_collapsed, 
                             Time.ms %in% points), size=3) +
    geom_line(data = filter(ms_mean_iChart_window_acc_collapsed, Time.ms %in% points), 
              size=0.7) +
    geom_linerange(data = filter(ms_mean_iChart_window_acc_collapsed, Time.ms %in% points),
                   aes(ymin=mean_prop_looking - ci_low, 
                       ymax=mean_prop_looking + ci_high), 
                   width = .03, size=0.3, alpha = 0.5) +
    scale_color_brewer(type = "qual", palette = "Set1") +
    scale_x_discrete(breaks = breaks) +
    # guides(color = F) +
    scale_y_continuous(limits=c(0.25, 1.0), breaks = y_breaks) +
    geom_hline(yintercept = 0.5, linetype="dashed") +
    theme_bw() +
    theme(axis.title.x = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))

b <- qplot(data = ms_mean_iChart_window_acc_collapsed_no_signer, x = Time.ms, y = mean_prop_looking,
      color=age_group, group = age_group, 
      geom = "blank", xlab=c("Time in ms from onset of noun"), 
      ylab=c("ACCURACY\nProportion\nlooking\nto target")) + 
    geom_point(data = filter(ms_mean_iChart_window_acc_collapsed_no_signer, 
                             Time.ms %in% points), size=3) +
    geom_line(data = filter(ms_mean_iChart_window_acc_collapsed_no_signer, Time.ms %in% points), 
              size=0.7) +
    geom_linerange(data = filter(ms_mean_iChart_window_acc_collapsed_no_signer, Time.ms %in% points),
                   aes(ymin=mean_prop_looking - ci_low, 
                       ymax=mean_prop_looking + ci_high), 
                   width = .03, size=0.3, alpha = 0.5) +
    scale_color_brewer(type = "qual", palette = "Set1") +
    scale_x_discrete(breaks = breaks) +
    # guides(color = F) +
    scale_y_continuous(limits=c(0.25, 1.0), breaks = y_breaks) +
    geom_hline(yintercept = 0.5, linetype="dashed") +
    theme_bw() +
    theme(axis.title.x = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))


gridExtra::grid.arrange(a, b, ncol = 1)
```

## CODAs vs. Deaf Analysis

### Summary data plots for CODAs vs. Deaf children.

```{r dplyr::summarise codas_deaf}
ms_coda_deaf <- ss_kids %>% 
    group_by(hearing_status_participant) %>% 
    dplyr::summarise(m_age = mean(age_peek_months),
              sd_age = sd(age_peek_months),
              m_fs = mean(C_T_prop),
              ci.h_ct = ci.high(C_T_prop),
              ci.l_ct = ci.low(C_T_prop),
              m_acc = mean(target_looking_signer),
              ci.h_acc = ci.high(target_looking_signer),
              ci.l_acc = ci.low(target_looking_signer),
              m_rt = mean(mean_correct_rt),
              ci.h_rt = ci.high(mean_correct_rt),
              ci.l_rt = ci.low(mean_correct_rt))
```

```{r codas fs acc}
codas_deaf_fs <- qplot(hearing_status_participant, m_fs, data = ms_coda_deaf, 
      fill = hearing_status_participant, geom = "bar", stat = "identity") +
    geom_linerange(aes(ymax = m_fs + ci.h_ct, ymin = m_fs - ci.l_ct)) +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    guides(fill=F) +
    ylim(0, 0.85) +
    xlab("Hearing Status") +
    ylab("Prop. Correct Shifts") + 
    ggtitle("First Shift Accuracy") +
    geom_hline(yintercept = 0.5, linetype = "dashed") +
    theme(plot.title = element_text(face = "bold", size = 20),
        axis.title.x = element_text(colour="grey40",size=18,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=18,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))

codas_deaf_acc <- qplot(hearing_status_participant, m_acc, data = ms_coda_deaf, 
      fill = hearing_status_participant, geom = "bar", stat = "identity") +
    geom_linerange(aes(ymax = m_acc + ci.h_acc, ymin = m_acc - ci.l_acc)) +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    guides(fill=F) +
    ylim(0, 0.85) +
    xlab("Hearing Status") +
    ylab("Prop. Looking to Target") +
    ggtitle("Accuracy") +
    geom_hline(yintercept = 0.3, linetype = "dashed") + 
    theme(plot.title = element_text(face = "bold", size = 20),
        axis.title.x = element_text(colour="grey40",size=18,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=18,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))

codas_deaf_rt <- qplot(hearing_status_participant, m_rt, data = ms_coda_deaf, 
      fill = hearing_status_participant, geom = "bar", stat = "identity") +
    geom_linerange(aes(ymax = m_rt + ci.h_rt, ymin = m_rt - ci.l_rt)) +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    guides(fill=F) +
    xlab("Hearing Status") +
    ylab("Mean RT (ms)") +
    ggtitle("Reaction Time") +
    theme(plot.title = element_text(face = "bold", size = 20),
        axis.title.x = element_text(colour="grey40",size=18,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=18,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))

gridExtra::grid.arrange(codas_deaf_acc, codas_deaf_rt, ncol = 2)
```

T.tests deaf vs. codas

```{r stats coda_deaf}
## hearing status
t.test(target_looking_signer ~ hearing_status_participant, data = ss_kids, var.equal = T)
t.test(mean_accuracy ~ hearing_status_participant, data = ss_kids, var.equal = T)
t.test(C_T_prop ~ hearing_status_participant, data = ss_kids, var.equal = T)
t.test(mean_correct_rt ~ hearing_status_participant, data = ss_kids, var.equal = T)
```

Effect size deaf vs. codas

```{r}
fs_coda <- ss_kids %>% filter(hearing_status_participant == "hearing") %>% select(C_T_prop)
fs_deaf <- ss_kids %>% filter(hearing_status_participant == "deaf") %>% select(C_T_prop)
fs_hearing_status_cohd <- round(effsize::cohen.d(fs_deaf$C_T_prop, fs_coda$C_T_prop)$estimate, 2)
```

### PP for CODAs vs. Deaf 

```{r, warning =F, echo =F}
breaks <- seq(0,3000, by=500)
y_breaks <- seq(0.25,1.0, by = 0.25)
points <- seq(0,3000, by = 200)

qplot(data = ms_graph_values_coda, x = Time.ms, y = mean_accuracy,
      color=hearing_status, geom = "blank", xlab=c("Time in ms from onset of noun"), 
      ylab=c("ACCURACY\nProportion\nlooking\nto target")) + 
    geom_point(data = filter(ms_graph_values_coda, Time.ms %in% points), size=3) +
    geom_line(data = filter(ms_graph_values_coda, Time.ms %in% points), size=0.7) +
    geom_linerange(data = filter(ms_graph_values_coda, Time.ms %in% points),
                   aes(ymin=mean_accuracy - ci.low, 
                       ymax=mean_accuracy + ci.high), 
                   width = .03, size=0.3, alpha = 0.5) +
    scale_color_brewer(type = "qual", palette = "Set1") +
    scale_x_discrete(breaks = breaks) +
    xlim(0,3000) +
    guides(color = F) +
    scale_y_continuous(limits=c(0.25, 1.0), breaks = y_breaks) +
    geom_hline(yintercept = 0.5, linetype="dashed") +
    theme_bw() +
    theme(axis.title.x = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))
```

### PP for CODAs vs. Deaf Signer removed

Get means and CIs for each participant for each time slice. Using two different Accuracy computations:

* Including looks to the signer
* Not including looks to the signer

```{r}
ss_coda_iChart_window_acc <- ss_iChart_long_window_acc %>% 
    filter(age_group != "Adults") %>% 
    group_by(Sub.Num, Time.ms, hearing_status_participant) %>% 
    dplyr::summarise(mean_prop_looking_subs = mean(to.n(value), na.rm = T))

ss_coda_iChart_window_acc_no_signer <- ss_iChart_long_window_acc %>% 
    filter(age_group != "Adults") %>% 
    group_by(Sub.Num, Time.ms, hearing_status_participant) %>% 
    dplyr::summarise(mean_prop_looking_subs = mean(to.n(value_signer_removed), na.rm = T))
```

Get means and CIs for each group

```{r}
ms_coda_iChart_window_acc_collapsed <- ss_coda_iChart_window_acc %>% 
    group_by(Time.ms, hearing_status_participant) %>% 
    dplyr::summarise(mean_prop_looking = mean(mean_prop_looking_subs, na.rm = T),
              ci_low = ci.low(mean_prop_looking_subs),
              ci_high = ci.high(mean_prop_looking_subs))

ms_coda_iChart_window_acc_collapsed_no_signer <- ss_coda_iChart_window_acc_no_signer %>% 
    group_by(Time.ms, hearing_status_participant) %>% 
    dplyr::summarise(mean_prop_looking = mean(mean_prop_looking_subs, na.rm = T),
              ci_low = ci.low(mean_prop_looking_subs),
              ci_high = ci.high(mean_prop_looking_subs))
```

Now plot the two accuracy measures against each other.

```{r}
breaks <- seq(0,2500, by=500)
y_breaks <- seq(0.25,1.0, by = 0.25)
points <- seq(0,2500, by = 100)

a <- qplot(data = ms_coda_iChart_window_acc_collapsed, x = Time.ms, y = mean_prop_looking,
           color=hearing_status_participant, group = hearing_status_participant, 
           geom = "blank", xlab=c("Time in ms from onset of noun"), 
           ylab=c("ACCURACY\nProportion\nlooking\nto target")) + 
    geom_point(data = filter(ms_coda_iChart_window_acc_collapsed, 
                             Time.ms %in% points), size=3) +
    geom_line(data = filter(ms_coda_iChart_window_acc_collapsed, Time.ms %in% points), 
              size=0.7) +
    geom_linerange(data = filter(ms_coda_iChart_window_acc_collapsed, Time.ms %in% points),
                   aes(ymin=mean_prop_looking - ci_low, 
                       ymax=mean_prop_looking + ci_high), 
                   width = .03, size=0.3, alpha = 0.5) +
    scale_color_brewer(type = "qual", palette = "Set1") +
    scale_x_discrete(breaks = breaks) +
    # guides(color = F) +
    scale_y_continuous(limits=c(0.25, 1.0), breaks = y_breaks) +
    geom_hline(yintercept = 0.5, linetype="dashed") +
    theme_bw() +
    theme(axis.title.x = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          plot.margin = unit(c(0.5,2,1,1), "cm"))

b <- qplot(data = ms_coda_iChart_window_acc_collapsed_no_signer, x = Time.ms, y = mean_prop_looking,
      color=hearing_status_participant, group = hearing_status_participant, 
      geom = "blank", xlab=c("Time in ms from onset of noun"), 
      ylab=c("ACCURACY\nProportion\nlooking\nto target")) + 
    geom_point(data = filter(ms_coda_iChart_window_acc_collapsed_no_signer, 
                             Time.ms %in% points), size=3) +
    geom_line(data = filter(ms_coda_iChart_window_acc_collapsed_no_signer, Time.ms %in% points), 
              size=0.7) +
    geom_linerange(data = filter(ms_coda_iChart_window_acc_collapsed_no_signer, Time.ms %in% points),
                   aes(ymin=mean_prop_looking - ci_low, 
                       ymax=mean_prop_looking + ci_high), 
                   width = .03, size=0.3, alpha = 0.5) +
    scale_color_brewer(type = "qual", palette = "Set1") +
    scale_x_discrete(breaks = breaks) +
    # guides(color = F) +
    scale_y_continuous(limits=c(0.25, 1.0), breaks = y_breaks) +
    geom_hline(yintercept = 0.5, linetype="dashed") +
    theme_bw() +
    theme(axis.title.x = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))


gridExtra::grid.arrange(a, b, ncol = 1)
```

### Summary plots comparing accuracy measures: CODAs vs. Deaf

```{r}
ms_acc_measures_old <- ss_coda_iChart_window_acc %>% 
    group_by(hearing_status_participant) %>%
    dplyr::summarise(m_acc = mean(mean_prop_looking_subs, na.rm = T),
              ci.h_acc = ci.high(mean_prop_looking_subs),
              ci.l_acc = ci.low(mean_prop_looking_subs))

ms_acc_measures <- ss_coda_iChart_window_acc_no_signer %>% 
    group_by(hearing_status_participant) %>%
    dplyr::summarise(m_acc = mean(mean_prop_looking_subs, na.rm = T),
              ci.h_acc = ci.high(mean_prop_looking_subs),
              ci.l_acc = ci.low(mean_prop_looking_subs))
```

```{r}
a <- qplot(hearing_status_participant, m_acc, data = ms_acc_measures, 
           fill = hearing_status_participant, geom = "bar", stat = "identity") +
    geom_linerange(aes(ymax = m_acc + ci.h_acc, ymin = m_acc - ci.l_acc)) +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    guides(fill=F) +
    ylim(0, 0.85) +
    xlab("Hearing Status") +
    ylab("Prop. Correct Shifts") + 
    ggtitle("Window Accuracy New") +
    geom_hline(yintercept = 0.5, linetype = "dashed") +
    theme(plot.title = element_text(face = "bold", size = 20),
          axis.title.x = element_text(colour="grey40",size=18,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=18,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          plot.margin = unit(c(0.5,2,1,1), "cm"))

b <- qplot(hearing_status_participant, m_acc, data = ms_acc_measures_old, 
           fill = hearing_status_participant, geom = "bar", stat = "identity") +
    geom_linerange(aes(ymax = m_acc + ci.h_acc, ymin = m_acc - ci.l_acc)) +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    guides(fill=F) +
    ylim(0, 0.85) +
    xlab("Hearing Status") +
    ylab("Prop. Correct Shifts") + 
    ggtitle("Window Accuracy Old") +
    geom_hline(yintercept = 0.5, linetype = "dashed") +
    theme(plot.title = element_text(face = "bold", size = 20),
          axis.title.x = element_text(colour="grey40",size=18,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=18,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          plot.margin = unit(c(0.5,2,1,1), "cm"))

gridExtra::grid.arrange(b, a, ncol = 2)

```

```{r t-test new acc}
ss_acc_measures <- ss_coda_iChart_window_acc_no_signer %>% 
    group_by(Sub.Num, hearing_status_participant) %>%
    dplyr::summarise(m_acc = mean(mean_prop_looking_subs, na.rm = T),
              ci.h_acc = ci.high(mean_prop_looking_subs),
              ci.l_acc = ci.low(mean_prop_looking_subs))

t.test(m_acc ~ hearing_status_participant, data = ss_acc_measures, var.equal = T)
```

### Tanenhaus plot codas vs. deaf

```{r coda-deaf-plot-munging}
# grab just the eye movement data and group information
ss_iChart_coda <- iChart %>% 
    filter(age_group != "Adults", Response == "D", GoodFirstGap == T, GoodLongestGap == T) %>% 
    select(Sub.Num, hearing_status_participant, Response, `0`:`4000`) 

# convert to long format
ss_iChart_long_coda <- ss_iChart_coda %>% 
    gather(key = Time.ms, value = value, `0`:`4000`) %>% 
    filter(value %in% c("0", "0.5", "1")) %>% 
    mutate(value_cat = factor(value, labels = c("Distractor", "Signer", "Target")),
           Time.ms_numeric = to.n(Time.ms)) 

# dplyr::summarise
ms_iChart_count_coda <- ss_iChart_long_coda %>% 
    group_by(Sub.Num, Time.ms, hearing_status_participant, value_cat) %>% 
    dplyr::summarise(count = ifelse(n() == 0, 0, n())) %>% 
    dplyr::summarise(sum_count = sum(count))
    
ms_iChart_coda <- as.data.frame(xtabs(~ Sub.Num + value_cat + Time.ms,
                                      data = ss_iChart_long_coda)) %>% 
    left_join(y = ms_iChart_count_coda, by = c("Time.ms", "Sub.Num")) %>% 
    mutate(proportion_looking = Freq / sum_count,
           hearing_status_participant_factor = as.factor(hearing_status_participant))

# get means and CIs for proportion looking at each time slice across particpants
ms_mean_iChart_coda <- ms_iChart_coda %>% 
    group_by(Time.ms, hearing_status_participant, value_cat) %>% 
    dplyr::summarise(mean_prop_looking = mean(proportion_looking, na.rm = T),
              ci_low = ci.low(proportion_looking),
              ci_high = ci.high(proportion_looking))
```

```{r coda-deaf-plot}
breaks <- seq(0,4000, by=500)
y_breaks <- seq(0.25,1.0, by = 0.25)
points <- seq(0,4000, by = 200)

ggplot(aes(x = to.n(Time.ms), y = mean_prop_looking, linetype = hearing_status_participant, 
           color = value_cat, shape = hearing_status_participant), 
       data = ms_mean_iChart_coda) + 
    ylim(0,1) +
    geom_rect(aes(xmin = 600, xmax = 2500, ymin = -Inf, ymax = Inf), alpha = 0.1, fill = "grey90", color = NA) +
    geom_line(data = filter(ms_mean_iChart_coda, Time.ms %in% points), size=1) +
    geom_linerange(data = filter(ms_mean_iChart_coda, Time.ms %in% points),
                   aes(ymin=mean_prop_looking - ci_low, 
                       ymax=mean_prop_looking + ci_high), 
                   width = .03, size=0.3, alpha = 0.7) +
    geom_point(data = filter(ms_mean_iChart_coda, to.n(Time.ms) %in% points), size=5, fill = "white") +
    scale_shape_manual(values = c(19, 21)) +
    scale_color_brewer(palette = "Set1", type = "qual") +
    xlim(0, 4000) +
    geom_hline(yintercept = 0.33, linetype = "dashed") +
    xlab("Time in ms from onset of noun") +
    ylab("Proportion looking") +
    theme_bw() +
    guides(color = F, linetype = F, fill = F, shape = F) +
    theme(axis.title.x = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=22,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"))
```

## Individual Participants Analysis 

```{r, warning = F, echo = F, fig.height=8, fig.width=10}
breaks <- seq(0,3000, by=500)
y_breaks <- seq(0.25,1.0, by = 0.25)
points_ss <- seq(0,3000, by = 200)

qplot(data = filter(ss.et.long, age_group != "Adults"), x = Time.ms, y = accuracy,
      color = hearing_status_participant,
      geom = "blank", xlab=c("Time in ms from onset of noun"), 
      ylab=c("Proportion Looking to Target")) + 
    geom_point(data = filter(ss.et.long, Time.ms %in% points_ss, age_group != "Adults"), 
               size=3) +
    geom_smooth(method = "loess", se=F) +
    scale_x_discrete(breaks = breaks) +
    scale_y_continuous(limits=c(0.25, 1.0), breaks = y_breaks) +
    geom_hline(yintercept = 0.5, linetype="dashed") +
    facet_wrap(~ Sub.Num + signs_produced + Months, ncol = 6) +
    #guides(color=F) +
    theme_bw() +
    xlim(0,3000) +
    theme(axis.title.x = element_text(colour="grey40",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=22,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=14,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=14,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"),
         panel.margin = unit(1, "lines"))

```

```{r, echo=F, eval=F, message=F, warning=F}
write.csv(x = ms_graph_values, file = "../../paper/sol_gvals.csv", row.names = F)
```

## Item-level Analysis

### PP by item

Read in graph values.

```{r}
# read in wide data for each stimuli set
ss.et.item.v1 <- read.table("sol-ichart-v1-post-gating_PP_graphValues_0_4000_minRT_33_maxRT_2933_lg_72_fg_15_n_16.txt", header = T)

ss.et.item.v2 <- read.table("sol-ichart-v2-post-gating_PP_graphValues_0_4000_minRT_100_maxRT_2967_lg_49_fg_34_n_13.txt", header = T)

# add column to track stimuli
ss.et.item.v1$stimuli <- "V1"
ss.et.item.v2$stimuli <- "V2"

ss.et.item <- dplyr::bind_rows(ss.et.item.v1, ss.et.item.v2)
```

Munge data for plotting

```{r, warning=F, message=F}
#strip X from header
names(ss.et.item) <- gsub("X", "", names(ss.et.item))

#create long form df for plotting
ss.et.item.long <- ss.et.item %>% 
    select(-Condition) %>% 
    gather(key = Time.ms, value = value, `0`:`3000`) %>% 
    tidyr::spread(key = statistic, value = value) %>% 
    mutate(Time.ms = as.numeric(as.character(Time.ms)),
           groupping = as.character(groupping)) %>% 
    rename(sign = groupping)

#munge target sign df for merging
sol_target_signs_df %<>% 
    separate(sign, into = c("sign", "signer"), sep = "_") %>% 
    mutate(stimuli = ifelse(signer == "p", "V1", "V2"))

#merge with eye tracking data
ss.et.item.long <- sol_target_signs_df %>% 
    select(sign, stimuli, length_ms) %>% 
    left_join(x = ss.et.item.long, by = c("sign", "stimuli")) 
```

### Plot by item data

```{r item PP, warning=F, echo=F, eval = F}
breaks <- seq(0,3000, by=500)
y_breaks <- seq(0.25,1.0, by = 0.25)
points <- seq(0,3000, by = 100)

# reorder by length of sign
ss.et.item.long$sign <- factor(ss.et.item.long$sign, 
                               levels = c("birdy", "teddy", "book",
                                          "kitty", "doll",  "car",
                                          "shoe", "ball"))

x <- qplot(data = filter(ss.et.item.long, stimuli == "V1"), x = Time.ms, y = mean,
      geom = "blank", xlab=c("Time in ms from onset of noun"), 
      ylab=c("Proportion looking to target")) + 
    geom_point(data = filter(ss.et.item.long, Time.ms %in% points, stimuli == "V1"), 
               size=3, 
               colour="#e41a1c") +
    geom_line(size=0.7, colour="#e41a1c") +
    geom_linerange(data = filter(ss.et.item.long, Time.ms %in% points, stimuli == "V1"),
                   aes(ymin=mean - se, 
                       ymax=mean + se), 
                   width = .03, 
                   size=0.3, 
                   alpha = 1,
                   colour="#e41a1c") +
    scale_color_brewer(type = "qual", palette = "Set1") +
    scale_x_discrete(breaks = breaks) +
    scale_y_continuous(limits=c(0.25, 1.0), breaks = y_breaks) +
    geom_hline(yintercept = 0.5, linetype="dashed") +
    geom_vline(aes(xintercept = length_ms), linetype = "dashed") +
    facet_wrap( ~ sign, ncol = 4) +
    guides(color=F) +
    theme_bw() +
    theme(axis.title.x = element_text(colour="grey40",size=16,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=16,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=12,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=12,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"),
         panel.margin = unit(1, "lines"))
```

```{r item PP 2, warning=F, echo =F, eval = F}
breaks <- seq(0,3000, by=500)
y_breaks <- seq(0.25,1.0, by = 0.25)
points <- seq(0,3000, by = 100)

ss.et.item.long$sign <- factor(ss.et.item.long$sign, 
                               levels = c("book", "teddy", "kitty", 
                                          "car", "ball", "birdy", 
                                          "doll", "shoe"))

y <- qplot(data = filter(ss.et.item.long, stimuli == "V2"), x = Time.ms, y = mean,
      geom = "blank", xlab=c("Time in ms from onset of noun"), 
      ylab=c("Proportion looking to target")) + 
    geom_point(data = filter(ss.et.item.long, Time.ms %in% points, stimuli == "V2"), 
               size=3,
               color = "#377eb8") +
    geom_line(size=0.7, color = "#377eb8") +
    geom_linerange(data = filter(ss.et.item.long, Time.ms %in% points, stimuli == "V2"),
                   aes(ymin=mean - se, 
                       ymax=mean + se), 
                   width = .03, 
                   size=0.3, 
                   alpha = 1,
                   color = "#377eb8") +
    scale_color_brewer(type = "qual", palette = "Set1") +
    scale_x_discrete(breaks = breaks) +
    scale_y_continuous(limits=c(0.25, 1.0), breaks = y_breaks) +
    geom_hline(yintercept = 0.5, linetype="dashed") +
    geom_vline(aes(xintercept = length_ms), linetype = "dashed") +
    facet_wrap( ~ sign, ncol = 4) +
    guides(color=F) +
    theme_bw() +
    theme(axis.title.x = element_text(colour="grey40",size=16,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey40",size=16,
                                      angle=90,hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=12,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=12,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
         plot.margin = unit(c(0.5,2,1,1), "cm"),
         panel.margin = unit(1, "lines"))
```

### Plot all items for both stimulus sets 

```{r, fig.height=8, fig.width=10, eval = F}
gridExtra::grid.arrange(x, y, ncol = 1)
```

### Plot RT distribution for each stimulus set. 

```{r, echo = F}
ggplot(data = iChart, aes(x=RT, fill = age_group_collapsed)) +
    geom_density(alpha=.5, position="identity") +
    theme_bw()
```

Add sign length information to iChart.

```{r eval = F}
iChart <- left_join(iChart, rename(sol_target_signs_df, clean_target_img = sign), 
                    by = c("clean_target_img", "stimuli"))
```

Get only good RTs: Center to Target shifts, within the analysis window.

```{r eval = F}
iChart_rt <- filter(iChart, trial_types == "C_T", RT >= analysis.window[1], RT <= analysis.window[2], is.na(length_ms) == FALSE)
```

### Plot RT distribution for each stimulus set and each sign. 

```{r, fig.width=10, fig.height = 7, eval = F}
a <- ggplot(data = filter(iChart_rt, stimuli == "V1"), aes(x=RT, fill = age_group)) +
    geom_histogram(alpha=1, position="identity", color = "black", bindwidth = 25) +
    facet_wrap(~ clean_target_img, scales = "fixed", ncol = 4) +
    geom_vline(aes(xintercept = length_ms), linetype = "solid", color = "red") +
    ggtitle("Vanilla 1 Stimuli") +
    theme_bw()

b <- ggplot(data = filter(iChart_rt, stimuli == "V2"), aes(x=RT, fill = age_group)) +
    geom_histogram(alpha=1, position="identity", color = "black", bindwidth = 25) +
    facet_wrap(~ clean_target_img, scales = "fixed", ncol = 4) +
    geom_vline(aes(xintercept = length_ms), linetype = "solid", color = "red") +
    ggtitle("Vanilla 2 Stimuli") +
    theme_bw()

gridExtra::grid.arrange(a, b, ncol = 1)
```

```{r, eval = F}
ms_rt_item <- iChart_rt %>% 
    group_by(Sub.Num, stimuli, clean_target_img, length_ms, age_group) %>% 
    dplyr::summarise(mean_rt = mean(RT, na.rm=T)) %>% 
    mutate(diff_rt = mean_rt - length_ms) %>% 
    group_by(stimuli, clean_target_img, length_ms, age_group) %>% 
    dplyr::summarise(mean_diff_rt = mean(diff_rt, na.rm=T))
```

```{r, eval = F}
ms_rt_item_group <- iChart_rt %>% 
    group_by(Sub.Num, stimuli, clean_target_img, length_ms, age_group) %>% 
    dplyr::summarise(mean_rt = mean(RT, na.rm=T)) %>% 
    mutate(diff_rt = mean_rt - length_ms) %>% 
    group_by(age_group) %>% 
    dplyr::summarise(mean_diff_rt = mean(diff_rt, na.rm=T),
              ci_low = ci.low(diff_rt),
              ci_high = ci.high(diff_rt))
```

```{r, eval = F}
qplot(data = ms_rt_item_group, x = age_group, y = mean_diff_rt, geom = "blank") +
    geom_bar(fill = "steelblue", stat = "identity", color = "black") +
    geom_linerange(aes(ymin=mean_diff_rt - ci_low, 
                       ymax=mean_diff_rt + ci_high)) +
    geom_hline(yintercept = 0)
```

### Plot difference between participants' mean RT by item and offset of that sign. 

```{r, eval = F}
ggplot(data = ms_rt_item, aes(x=mean_diff_rt, fill=stimuli)) +
    geom_histogram(alpha=1, position="dodge", colour="black") +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_text(aes(x = mean_diff_rt, y = 1.5, label = clean_target_img), 
              angle = 90,
              position = "jitter") +
    facet_wrap(~ age_group, ncol = 1) + 
    theme_bw()
```

## Scatter plots of individual differences

```{r plot correlations}
acc_age_plot <- qplot(x = Months, y = target_looking_no_signer, data = ss_kids,
      ylab=c("Window Accuracy"), 
      xlab=c("Child's Age (months)")) +
    ylim(0.44, 0.85) +
    xlim(15, 55) +
    geom_smooth(method = "lm", se=F, color="black", size = 1.5) +
    geom_point(color = "black", size = 5.5) +
    geom_point(color = "grey50", size = 4) +
    # annotate("text", x = 30, y = 0.8, label = paste("r =", acc_voc_r), size=8) +
    theme_bw() + 
    theme(axis.title.x = element_text(colour="grey30",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey30",size=22,
                                      hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          panel.grid.major=element_blank())

rt_age_plot <- qplot(x = Months, y = median_ct_rt, 
                     data = filter(ss_medians, age_group_collapsed == "Kids"),
      ylab=c("Reaction Time (ms)"), 
      xlab=c("Child's Age (months)")) +
    ylim(800, 1950)  +
    xlim(15, 55) +
    geom_smooth(method = "lm", se=F, color="black", size = 1.5) +
    geom_point(color = "black", size = 5.5) +
    geom_point(color = "grey50", size = 4) +
    # annotate("text", x = 30, y = 0.8, label = paste("r =", acc_voc_r), size=8) +
    theme_bw() + 
    theme(axis.title.x = element_text(colour="grey30",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey30",size=22,
                                      hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          panel.grid.major=element_blank())

acc_voc_plot <- qplot(x = signs_produced, y = target_looking_no_signer, data = ss_kids,
      ylab=c("Window Accuracy"), 
      xlab=c("Signs Produced")) +
    ylim(0.44, 0.85) +
    xlim(15, 85) +
    geom_smooth(method = "lm", se=F, color="black", size = 1.5) +
    geom_point(color = "black", size = 5.5) +
    geom_point(color = "grey50", size = 4) +
    #annotate("text", x = 30, y = 0.8, label = paste("r =", acc_voc_r), size=8) +
    theme_bw() + 
    theme(axis.title.x = element_text(colour="grey30",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey30",size=22,
                                      hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          panel.grid.major=element_blank())

rt_voc_plot <- qplot(x = signs_produced, y = median_ct_rt, data = ss_rt,
      ylab=c("Reaction Time (ms)"), 
      xlab=c("Signs Produced")) +
    ylim(800, 1950) +
    xlim(15, 85) +
    geom_smooth(method = "lm", se=F, color="black", size = 1.5) +
    geom_point(color = "black", size = 5.5) +
    geom_point(color = "grey50", size = 4) +
    #annotate("text", x = 65, y = 1750, label = paste("r =", rt_voc_r), size=8) +
    theme_bw() + 
    theme(axis.title.x = element_text(colour="grey30",size=22,
                                      angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.title.y = element_text(colour="grey30",size=22,
                                      hjust=0.5,vjust=0.5,face="plain"),
          axis.text.x = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          axis.text.y = element_text(colour="grey20",size=18,
                                     angle=0,hjust=0.5,vjust=0,face="plain"),
          panel.grid.major=element_blank())

gridExtra::grid.arrange(acc_age_plot, rt_age_plot, ncol = 2)

gridExtra::grid.arrange(acc_voc_plot, rt_voc_plot, ncol = 2)

```

## Models

```{r}
fit_rt1 <- lm(mean_correct_rt ~ signs_produced, data = ss_rt)
fit_rt2 <- lm(mean_correct_rt ~ signs_produced + age_peek_months, data = ss_rt)
fit_rt3 <- lm(mean_correct_rt ~ age_peek_months, data = ss_rt)
```

R-squared change when adding age to the model.

```{r}
summary(fit_rt2)$r.squared - summary(fit_rt3)$r.squared
```